%--------------------------------------------
%
% Package pgfplots
%
% Provides a user-friendly interface to create function plots (normal
% plots, semi-logplots and double-logplots).
% 
% It is based on Till Tantau's PGF package.
%
% Copyright 2007/2008/2009 by Christian Feuers√§nger.
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%
%--------------------------------------------

\newif\ifpgfmanualpdfwarnings
\pgfmanualpdfwarningstrue

\pgfkeys{%
	/codeexample/prettyprint/cs arguments/pgfkeys/.initial=1,
	/codeexample/prettyprint/cs/pgfkeys/.code 2 args={\pgfmanualpdfref{#1}\{\pgfmanualprettyprintpgfkeys{#2}\}},
	/codeexample/prettyprint/cs arguments/pgfplotsset/.initial=1,
	/codeexample/prettyprint/cs/pgfplotsset/.code 2 args={\pgfmanualpdfref{#1}\{\pgfmanualprettyprintpgfkeys{#2}\}},
	/codeexample/prettyprint/cs arguments/pgfplotstableset/.initial=1,
	/codeexample/prettyprint/cs/pgfplotstableset/.code 2 args={\pgfmanualpdfref{#1}\{\pgfmanualprettyprintpgfkeys{#2}\}},
	%
	/codeexample/prettyprint/autolinks/.style={%
		/codeexample/prettyprint/key name/.code={\pgfmanualpdfref{##1}{##1}},
		/codeexample/prettyprint/key name with handler/.code 2 args={\pgfmanualpdfref{##1}{##1}/\pgfmanualpdfref{/handlers/##2}{##2}},
		/codeexample/prettyprint/key value display only/.code={##1},
		/codeexample/prettyprint/cs/.code={\pgfmanualpdfref{##1}{##1}},
		/codeexample/prettyprint/cs with args/.code 2 args={\pgfmanualpdfref{##1}{##1}\{##2\}},
		/codeexample/prettyprint/cs arguments/pgfkeys/.initial=1,
		/codeexample/prettyprint/cs/pgfkeys/.code 2 args={\pgfmanualpdfref{##1}{##1}\{\pgfmanualprettyprintpgfkeys{##2}\}},
		/codeexample/prettyprint/cs arguments/begin/.initial=1,
		/codeexample/prettyprint/cs/begin/.code 2 args={##1\{\pgfmanualpdfref{##2}{##2}\}},
		/codeexample/prettyprint/cs arguments/end/.initial=1,
		/codeexample/prettyprint/cs/end/.code 2 args={##1\{\pgfmanualpdfref{##2}{##2}\}},
		/codeexample/prettyprint/cs arguments/usepgfplotslibrary/.initial=1,
		/codeexample/prettyprint/cs/usepgfplotslibrary/.code 2 args={##1\{\pgfmanualpdfref{##2}{##2}\}},
		/codeexample/prettyprint/cs/usetikzlibrary/.code 2 args={##1\{\pgfmanualpdfref{##2}{##2}\}},
		/codeexample/prettyprint/cs/usepgflibrary/.code 2 args={##1\{\pgfmanualpdfref{##2}{##2}\}},
	},%
	/codeexample/prettyprint/autolinks,
}%

\pgfkeys{
	% whenever an unqualified key is found, the following key prefix
	% list is tried to find a match.
	/pdflinks/search key prefixes in/.initial={/pgfplots/,/pgfplots/table/,/tikz/,/pgf/},
	%
	% Enables or disables warnings for failed auto links:
	/pdflinks/warnings/.is if=pgfmanualpdfwarnings,
	/pdflinks/warnings/.default=true,
	%
	% Enables or disables the parsing of codeexamples.
	/pdflinks/codeexample links/.is if=pgfmanualprettyenabled,
	/pdflinks/codeexample links/.default=true,
	%
	% the link prefix written to the pdf file:
	/pdflinks/internal link prefix/.initial=pgfplots,
}

% this is pgfplots-specific: pgfplots supports generic styles which
% contain '\x' where '\x' iterates through 'x,y,z'.
\newif\ifpgfmanualpdf@hasxyzoption

\def\pgfmanualpdf@installreplacements{%
	\def\marg##1{{##1}}%
	\def\oarg##1{[##1]}%
	\def\meta##1{<##1>}%
	\def\x{x}%
	\def\textbackslash{<CS>}%
	\def\\{\textbackslash}%
	\edef\ {\space}%
	\edef\#{}%
}%

% Defines a new pdf cross ref label for use with \pgfmanualpdfref.
%
% #1: the label.
% The text #2 will be shown in the resulting pdf.
\def\pgfmanualpdflabel#1#2{%
	\begingroup
	\pgfmanualpdf@installreplacements%
	%
	\pgfutil@in@\x{#1}%
	\ifpgfutil@in@
		\pgfmanualpdf@hasxyzoptiontrue
	\fi
	\edef\pgfmanualpdflabel@@{#1}%
	\pgfutil@ifundefined{pgfmanual@wrotehyperlabel@\pgfmanualpdflabel@@}{%
		\pgfmanualpdflabel@generate{#1}{#2}%
		\ifpgfmanualpdf@hasxyzoption
			\def\x{y}%
			\pgfmanualpdflabel@generate{#1}{#2}%
			\def\x{z}%
			\pgfmanualpdflabel@generate{#1}{#2}%
		\fi
	}{%
		#2%
	}%
	\endgroup
}%
\def\pgfmanualpdflabel@generate#1#2{%
	\immediate\write\@auxout{%
		\noexpand\expandafter\noexpand\gdef
		\noexpand\csname pgfmanual@hashyperlabel@\pgfmanualpdflabel@@\noexpand\endcsname{1}%
	}%
	\expandafter\gdef\csname pgfmanual@hashyperlabel@\pgfmanualpdflabel@@\endcsname{1}%
	\expandafter\gdef\csname pgfmanual@wrotehyperlabel@\pgfmanualpdflabel@@\endcsname{1}%
	\edef\pgfmanualpdflabel@@{\pgfkeysvalueof{/pdflinks/internal link prefix}.\pgfmanualpdflabel@@}%
	\expandafter\hypertarget\expandafter{\pgfmanualpdflabel@@}{#2}%
}%

%\def\declarewithhyperref#1{%
%	\pgfmanualpdflabel{#1}{{\color{red!75!black}#1}}%
%}%

\def\pgfmanualpdfref#1#2{%
	\begingroup
	\pgfmanualpdf@installreplacements
	%
	%
	% backslashes might produce problems. 
	% This occurs quite frequently with automatically generated hyperrefs 
	% inside of codeexamples where \pgfmanualpdfref will be invoked - 
	% there, we get the catcode 12 backslashes. 
	% Check for them:
	\expandafter\pgfutil@in@\pgfmanual@pretty@backslash{#1}%
	\ifpgfutil@in@
		% assume the backslash is the first char and substitute it:
		\def\pgfmanualpdfref@substitute@backslash##1##2\relax{%
			\edef\pgfmanualpdflabel@@{\textbackslash ##2}%
		}%
		\pgfmanualpdfref@substitute@backslash#1\relax
	\else
		\edef\pgfmanualpdflabel@@{#1}%
	\fi
	%
	\pgfutil@ifundefined{pgfmanual@hashyperlabel@\pgfmanualpdflabel@@}{%
		\global\let\pgfmanual@glob=\pgfmanualpdflabel@@
		\def\pgfmanual@tempa{\foreach \prefix in }%
		\pgfkeysgetvalue{/pdflinks/search key prefixes in}\pgfmanual@tempb
		\expandafter\pgfmanual@tempa\expandafter{\pgfmanual@tempb}{%
			\pgfutil@ifundefined{pgfmanual@hashyperlabel@\prefix\pgfmanualpdflabel@@}{%
			}{%
				\xdef\pgfmanual@glob{\prefix\pgfmanualpdflabel@@}%
				\breakforeach
			}%
		}%
		\let\pgfmanualpdflabel@@=\pgfmanual@glob
		\pgfutil@ifundefined{pgfmanual@hashyperlabel@\pgfmanualpdflabel@@}{%
			\ifpgfmanualpdfwarnings
				\begingroup
					\toks0={#1}%
					\pgfplots@warning{pgfmanualpdfref{\the\toks0 }: target label does not exist.}%
				\endgroup
			\fi
			#2%
			\let\pgfmanualpdflabel@@=\pgfutil@empty
		}{}%
	}{}%
	\ifx\pgfmanualpdflabel@@\pgfutil@empty
	\else
		\expandafter\pgfmanualpdfref@\expandafter{\pgfmanualpdflabel@@}{#2}%
	\fi
	\endgroup
}%
\def\pgfmanualpdfref@#1#2{%
	\pgfkeysgetvalue{/pdflinks/internal link prefix}\pgfmanual@temp
	\expandafter\hyperlink\expandafter{\pgfmanual@temp.#1}{#2}%
}%

