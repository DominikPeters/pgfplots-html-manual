%--------------------------------------------
% $Header: /cvsroot/pgfplots/pgfplots/generic/pgfplots/libs/pgflibrarysurfshading.code.tex,v 1.6 2009/03/02 17:27:18 ludewich Exp $
%
% Package pgfplots
%
% Provides a user-friendly interface to create function plots (normal
% plots, semi-logplots and double-logplots).
% 
% It is based on Till Tantau's PGF package.
%
% Copyright 2007/2008 by Christian Feuers√§nger.
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%
%--------------------------------------------

%--------------------------------------------------
% \pgfkeyssetvalue{/pgfplots/surf shading/cols}{2}
% \pgfplotslibrarysurfstreamstart
% \pgfplotslibrarysurfstreamcoord{\pgfqpoint{0pt}{10pt}}{0}
% \pgfplotslibrarysurfstreamcoord{\pgfqpoint{100pt}{10pt}}{100}
% \pgfplotslibrarysurfstreamcoord{\pgfqpoint{0pt}{300pt}}{300}
% \pgfplotslibrarysurfstreamcoord{\pgfqpoint{150pt}{300pt}}{1000}
% \pgfplotslibrarysurfstreamend
% \pgfplotslibrarysurfdraw
%-------------------------------------------------- 


\pgfkeys{%
	/pgfplots/surf shading/south west corner/.initial={\pgfpointorigin},%
	/pgfplots/surf shading/north east corner/.initial={\pgfqpoint{15cm}{15cm}},%
	/pgfplots/surf shading/anchor/.initial=\pgfpointorigin,%
	/pgfplots/surf shading/cols/.initial=,%
}%

\def\pgfplotslibrarysurf@corner@sw{\pgfkeysvalueof{/pgfplots/surf shading/south west corner}}
\def\pgfplotslibrarysurf@corner@ne{\pgfkeysvalueof{/pgfplots/surf shading/north east corner}}%

% FIXME !!!!
\def\pgfplotslibrarysurf@corner@sw{\pgfqpoint{-100pt}{-10pt}}
\def\pgfplotslibrarysurf@corner@ne{\pgfqpoint{15cm}{15cm}}%


\def\pgfplotslibrarysurf@decode@CDATAMAX{64000}
\def\pgfplotslibrarysurf@decode{%
	-16384.9 16384.9 % map TeX coordinates 1:1
	-16384.9 16384.9
	0 65535% map 1:1 -> then, the highest loaded CDATA value will be CDATAMAX 
}%
\def\pgfplotslibrarysurf@count{0}%

\def\pgfplotslibrarysurfstreamstart{%
	\pgfplotsapplistXnewempty\pgfplotslibrarysurf@binarystream@accum
}%
\def\pgfplotslibrarysurfstreamend{%
	\pgfplotsapplistXlet\pgfplotslibrarysurf@binarystream=\pgfplotslibrarysurf@binarystream@accum
}%

% #1: a pgf point.
% #2: a color coordinate in the range [0,1000]
\def\pgfplotslibrarysurfstreamcoord#1#2{%
	\pgfkeysvalueof{/pgfplots/bin/bytes/.@cmd}4\pgfeov
	\pgf@process{#1}%
	% The idea is to map 
	% the low-level point coordinates LINEARLY into [0,2^{8*<bytes>}].
	%
	% This is what the pdf standard expects for surface shadings.
	%
	% To do that, we simply map
	% [-16384,16384] linearly into [0,2^{32}]
	% and write the resulting integer in big endian binary format to
	% the pdf low level stream.
	%
	% The decode procedure tells the pdf viewer how to invert that
	% stuff.
	%
	%% DEBUG NOTE: This mapping appears to work correctly according to
	%% my tests.
	%% For bc -l test codes: 
	%% set ibase=16; 
	%% -4000 +  809658FA. / (2^20) * 8000
	%
	% FIXME : these coordinates ARE NOT USER SPACE CORRECTED.
	% SO: either use them as fill path for the surfaces rectangle
	% (which may work, I don't know) or make sure they are mapped
	% correctly into "user space".
	\pgf@sys@bp@correct\pgf@x%
%\message{ENCODING x  = \the\pgf@x.}%
	\pgfplotsbinaryencodedimenmaplinearly\pgf@x
	\t@pgfplots@toka=\expandafter{\pgfplotsbinaryresult}%
	\pgf@sys@bp@correct\pgf@y%
%\message{ENCODING y  = \the\pgf@y.}%
	\pgfplotsbinaryencodedimenmaplinearly\pgf@y
	\t@pgfplots@tokb=\expandafter{\pgfplotsbinaryresult}%
	{%
		% convert to pt:
		\pgf@xa=#2pt
		% convert to integer (= *65536):
		\c@pgf@counta=\pgf@xa
		% enlarge data range from 1000*65536 to 16000*65536 ~= 2^14 * 2^16:
		\multiply\c@pgf@counta by16
		% quantize into 16 bit range divide by 2^14:
		\divide\c@pgf@counta by16384
\message{conversion \the\pgf@xa\space -> \the\c@pgf@counta\space.}%
		%\afterassignment\pgfplotslibrarysurf@gobbletillrelax
		%\expandafter\c@pgf@counta\the\pgf@xa\relax
		\xdef\pgfplots@glob@TMPa{\the\c@pgf@counta}%
	}%
%\message{ENCODING C = \pgfplots@glob@TMPa.}%
	\pgfkeysvalueof{/pgfplots/bin/bytes/.@cmd}2\pgfeov
	\pgfplotsbinaryencodeunsigned\pgfplots@glob@TMPa
	\t@pgfplots@tokc=\expandafter{\pgfplotsbinaryresult}%
	\edef\pgfplots@loc@TMPa{\the\t@pgfplots@toka\the\t@pgfplots@tokb\the\t@pgfplots@tokc}%
	\expandafter\pgfplotsapplistXpushback\pgfplots@loc@TMPa\to\pgfplotslibrarysurf@binarystream@accum
}
\def\pgfplotslibrarysurf@gobbletillrelax#1\relax{}%

\def\pgfplotslibrarysurfactivateshadefill{%
	\pgfplotssys@do@surfshading@fillpaths%
}

%--------------------------------------------------
% \def\pgfplotslibrarysurfdraw{%
% %	\pgftext[at=\pgfqpoint{0pt}{0pt}]%
% 		{\pgfplotssys@do@surfshading}%
% }%
%-------------------------------------------------- 

\def\pgfplotslibrarysurfdrawinpicture{%
	\begingroup
	\pgftransformshift{\pgfplotslibrarysurf@corner@sw}%
	\pgftext[at=\pgfqpoint{0pt}{0pt},left,bottom] {%
		\pgfplotslibrarysurfdraw
	}%
	\endgroup
}
\def\pgfplotslibrarysurfdraw{%
	\begingroup
	\setbox\pgfutil@tempboxa=\hbox{%
		\pgfpicture
		\pgfplotslibrarysurfactivateshadefill
		\pgfpathrectanglecorners
			{\pgfplotslibrarysurf@corner@sw}
			{\pgfplotslibrarysurf@corner@ne}%
		\pgfusepath{fill}%
		\endpgfpicture
	}%
	\pdfxform resources{}\pgfutil@tempboxa
	\leavevmode
	\pdfrefxform\pdflastxform
	\endgroup
}

% FIXME : DEPRECATED  I can't use the '/sh' operator - it's not
% powerfull enough (I need to change /Matrix which is not supported by
% /sh).
%
% DEPRECATED
\def\pgfplotssys@do@surfshading{%
	{%
		\pdfobj stream attr {%
			% stream length will be computed automatically
			%/Shading 
			/ShadingType 5
			/BitsPerCoordinate 32
			/BitsPerComponent 16
			/VerticesPerRow \pgfkeysvalueof{/pgfplots/surf shading/cols}
			/ColorSpace /DeviceRGB
			/Decode [\pgfplotslibrarysurf@decode]
			/Function 
			<< 
				/FunctionType 3 
				/Domain [0.0 \pgfplotslibrarysurf@decode@CDATAMAX] 
				/Functions [ 
					<< 
						/FunctionType 2 
						/Domain [0.0 \pgfplotslibrarysurf@decode@CDATAMAX] 
						/C0 [0 0 1] /C1 [1 1 0] /N 1 
					>>  
					<< 
						/FunctionType 2 
						/Domain [0.0 \pgfplotslibrarysurf@decode@CDATAMAX] 
						/C0 [1 1 0] /C1 [1 0.5 0] /N 1 
					>>  
					<< 
						/FunctionType 2 
						/Domain [0.0 \pgfplotslibrarysurf@decode@CDATAMAX] 
						/C0 [1 0.5 0] /C1 [1 0 0] /N 1 
					>>
				]
				/Bounds [ 2000 6000 ] 
				/Encode [0 1  0 1 0 1] 
			>> 
		} {%
			\pgfplotslibrarysurf@binarystream
		}%
		%--------------------------------------------------
		% \pdfobj {%
		% 	/TemporaryShade % this can be deleted. I use it to check what works - substitute /Plotsurface with /TemporaryShade to activate it.
		% 	<<
		% 		/ShadingType 2 
		% 		/ColorSpace /DeviceRGB
		% 		/Domain [0.0 226.76788] 
		% 		/Coords [0.0 0 226.76788 0] 
		% 		/Function 
		% 		<< 
		% 			/FunctionType 3 
		% 			/Domain [0.0 226.76788] 
		% 			/Functions [ 
		% 				<< 
		% 					/FunctionType 2 
		% 					/Domain [0.0 226.76788] 
		% 					/C0 [0 0 1] /C1 [1 1 0] /N 1 
		% 				>>  
		% 				<< 
		% 					/FunctionType 2 
		% 					/Domain [0.0 226.76788] 
		% 					/C0 [1 1 0] /C1 [1 0.5 0] /N 1 
		% 				>>  
		% 				<< 
		% 					/FunctionType 2 
		% 					/Domain [0.0 226.76788] 
		% 					/C0 [1 0.5 0] /C1 [1 0 0] /N 1 
		% 				>>
		% 			]
		% 			/Bounds [ 75.5893 151.17859] 
		% 			/Encode [0 1  0 1 0 1] 
		% 		>> 
		% 		/Extend [false false] 
		% 	>> 
		% }%
		%-------------------------------------------------- 
		% I don't know how to insert the shading into a properly sized PDF entity - this here appears to work.
		\pgfpointdiff%
			{\pgfplotslibrarysurf@corner@sw}%
			{\pgfplotslibrarysurf@corner@ne}%
		\setbox\pgfutil@tempboxa=\hbox to\pgf@x{%
			\vbox to\pgf@y{%
				\vfil
				\pgfsys@invoke{%
					/Plotsurface\pgfplotslibrarysurf@count\space sh% invoke 'sh'ading operator on /Plotsurface
				}%
			}%
			\hfil}%
		\pdfxform resources {%
			% the /Shading is a resource directory (predefined name)
			% while /Plotsurface is my name. Since type 5 shadings are
			% a stream, we need to reference them this way:
			/Shading << /Plotsurface\pgfplotslibrarysurf@count\space \the\pdflastobj\space 0 R >>
		}\pgfutil@tempboxa
		\pgfplotsutil@advancestringcounter@global\pgfplotslibrarysurf@count
		%--------------------------------------------------
		% \pgf@process{\pgfpoint{\pgf@max}{#2}}%
		% \pdfxform resources {%
		% 	/Shading << 
		% 		/Sh << 
		% /Length <BYTES>
		% 			/ShadingType 5
		% 			/BitsPerCoordinate 32
		% 			/BitsPerComponent 16
		% 			/VerticesPerRow \pgfplotslibrarysurf@cols
		% 			/ColorSpace /DeviceRGB
		% 			/Decode [xmin xmax ymin ymax c1min c1max c2min c2max c3min c3max ]
		% 		>> 
		% 	>>}\pgfutil@tempboxa% <<
		%-------------------------------------------------- 
		\xdef\pgfplots@glob@TMPa{%
			\leavevmode
			\noexpand\pdfrefobj\the\pdflastobj
			\noexpand\pdfrefxform\the\pdflastxform}% 
	}%
	\pgfplots@glob@TMPa
}
\def\pgfplotssys@do@surfshading@fillpaths{%
	\immediate\pdfobj stream attr {%
		% stream length will be computed automatically
		%/Shading 
		/ShadingType 5
		/BitsPerCoordinate 32
		/BitsPerComponent 16
		/VerticesPerRow \pgfkeysvalueof{/pgfplots/surf shading/cols}
		/ColorSpace /DeviceRGB
		/Decode [\pgfplotslibrarysurf@decode]
		/Function 
		<< 
			/FunctionType 3 
			/Domain [0.0 \pgfplotslibrarysurf@decode@CDATAMAX] 
			/Functions [ 
				<< 
					/FunctionType 2 
					/Domain [0.0 \pgfplotslibrarysurf@decode@CDATAMAX] 
					/C0 [0 0 1] /C1 [1 1 0] /N 1 
				>>  
				<< 
					/FunctionType 2 
					/Domain [0.0 \pgfplotslibrarysurf@decode@CDATAMAX] 
					/C0 [1 1 0] /C1 [1 0.5 0] /N 1 
				>>  
				<< 
					/FunctionType 2 
					/Domain [0.0 \pgfplotslibrarysurf@decode@CDATAMAX] 
					/C0 [1 0.5 0] /C1 [1 0 0] /N 1 
				>>
			]
			/Bounds [ 21300 42600 ] 
			/Encode [0 1  0 1 0 1] 
		>> 
	} {%
		\pgfplotslibrarysurf@binarystream
	}%
	\edef\pgfplots@loc@TMPa{\the\pdflastobj}%
	\pgf@process{\pgfpointdiff{\pgfplotslibrarysurf@corner@sw}{\pgfkeysvalueof{/pgfplots/surf shading/anchor}}}%
	\pgf@sys@bp@correct\pgf@x%
	\pgf@sys@bp@correct\pgf@y%
	\immediate\pdfobj {<<
		/Type /Pattern
		/PatternType 2
%		/Matrix [\pgf@pt@aa\space\pgf@pt@ab\space\pgf@pt@ba\space\pgf@pt@bb\space\pgf@sys@tonumber\pgf@pt@x\space\pgf@sys@tonumber\pgf@pt@y]
		% FIXME : where does the '2' come from? BUG!
		% FIXME: INCORPORATE TIKZ CM
		/Matrix [2 0 0 2 \pgf@sys@tonumber\pgf@x\space \pgf@sys@tonumber\pgf@y] %226.533 518.141] 
		%--------------------------------------------------
		% /ExtGState 
		% 	<<
		% 		/LW 2
		% 		/OP true
		% 		/OPM 1
		% 	>>
		%-------------------------------------------------- 
		/Shading 
			% A debug switch:
			\iftrue
				\pgfplots@loc@TMPa\space 0 R 
			\else
			\iftrue
			<<
				/ShadingType 2 
				/ColorSpace /DeviceRGB
				% these coordinates have been choosen consistently
				% with the clip path of my axis rectangle (in a test
				% figure) It's debugging stuff.
				/Coords [-86 0 150 0] 
				/Function 
				<< 
					/FunctionType 2 
					/Domain [0.0 1.0] 
					/C0 [0 0 1] /C1 [1 0 0] /N 1 
				>> 
				/Extend [false false] 
			>> 
			\else
			<<
				/ShadingType 2 
				/ColorSpace /DeviceRGB
				/Domain [0.0 226.76788] 
				/Coords [0.0 0 226.76788 0] 
				/Function 
				<< 
					/FunctionType 3 
					/Domain [0.0 226.76788] 
					/Functions [ 
						<< 
							/FunctionType 2 
							/Domain [0.0 226.76788] 
							/C0 [0 0 1] /C1 [1 1 0] /N 1 
						>>  
						<< 
							/FunctionType 2 
							/Domain [0.0 226.76788] 
							/C0 [1 1 0] /C1 [1 0.5 0] /N 1 
						>>  
						<< 
							/FunctionType 2 
							/Domain [0.0 226.76788] 
							/C0 [1 0.5 0] /C1 [1 0 0] /N 1 
						>>
					]
					/Bounds [ 75.5893 151.17859] 
					/Encode [0 1  0 1 0 1] 
				>> 
				/Extend [false false] 
			>> 
			\fi
			\fi
	>>}%
	\edef\pgfplots@loc@TMPa{%
		/pgfpatPlotsurface\pgfplotslibrarysurf@count\space \the\pdflastobj\space 0 R
		%--------------------------------------------------
		% /pgfpatPlotsurface <<
		% 	/Type /Pattern
		% 	/PatternType 2
		% 	/Shading \the\pdflastobj\space 0 R 
		% >>
		%-------------------------------------------------- 
	}%
	\expandafter\pgfutil@addpdfresource@patterns\expandafter{\pgfplots@loc@TMPa}%%
	\pgfsys@setpatterncolored{Plotsurface\pgfplotslibrarysurf@count}%
	\pgfplotsutil@advancestringcounter@global\pgfplotslibrarysurf@count
%	\pgfsetfillcolor{blue}%
}

