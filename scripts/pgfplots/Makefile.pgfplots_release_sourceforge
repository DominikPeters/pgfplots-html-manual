# dummy release script
#
# DO NOT invoke this from a pgfplots directory, 
# use 
# make -f pgfplots/scripts/pgfplots/Makefile.pgfplots_release_sourceforge
VERSION=_unstable
#VERSION=_1.5.1

ZIP=pgfplots$(VERSION).tds.zip
PDF=pgfplots$(VERSION).pdf
TEX_NOTES=pgfplots/doc/latex/pgfplots/TeX-programming-notes.pdf
PDFTABLE=pgfplotstable$(VERSION).pdf
CHANGELOG=ChangeLog$(VERSION)
README=README$(VERSION)
REVISIONFILE=pgfplots$(VERSION).revision

files: zip pdf $(README) $(CHANGELOG)

all: uploaddist download gallery 

zip: $(ZIP)

pdf: $(PDF) $(PDFTABLE)

revisionfile: $(REVISIONFILE)

uploadindexhtml: /tmp/index.html
	scp $< ludewich,pgfplots@web.sourceforge.net:htdocs/
	

upload: $(ZIP) $(PDF) $(PDFTABLE) $(CHANGELOG) $(README) $(REVISIONFILE)
	scp $^ $(TEX_NOTES) ludewich,pgfplots@web.sourceforge.net:htdocs/

uploaddist: $(ZIP) $(PDF) $(PDFTABLE)
	scp pgfplots/doc/latex/pgfplots/pgfplots.pdf \
		pgfplots/doc/latex/pgfplots/pgfplotstable.pdf \
		ludewich,pgfplots@web.sourceforge.net:htdocs/

FORCE:

$(ZIP): FORCE
	rm -fr /tmp/pgfplots /tmp/$@
	cd pgfplots && scripts/pgfplots/pgfplotsrevisionfile.sh
	rsync --copy-links \
		--exclude=.git \
		--exclude='.*.sw?' \
		--exclude='*.aux' \
		--exclude='*.log' \
		--exclude='*~' \
		--exclude='*.bbl' \
		--exclude='*.blg' \
		--exclude='*.idx' \
		--exclude='*.ilg' \
		--exclude='*.log' \
		--exclude='*.ind' \
		--exclude='*.toc' \
		--exclude='*.out' \
		--exclude='*.djs' \
		--exclude='*.tmp' \
		--exclude='*.tuo' \
		--exclude='*.tui' \
		--exclude='*.top' \
		--exclude='*.pgf' \
		--exclude='*.mp' \
		--exclude='*.md5' \
		--exclude='.gitignore' \
		--exclude='.cvsignore' \
		--exclude='pgfplotsrevisionfile.sh' \
		--exclude='pgfplots_in_ubuntu.readme.txt' \
		--exclude='pgfplotstable.example1.out.*' \
		--exclude='source/latex/pgfplots/pgfplotstest/unittests/references' \
		--exclude='*.diff' \
		--exclude='expensiveexample*' \
		--exclude='Makefile.pgfplots_release_sourceforge' \
		--exclude='pgfplotsDEV_copy_files_from_pgf.sh' \
		-r pgfplots /tmp
	make -C /tmp/pgfplots/doc/latex/pgfplots/gallery/ clean
	find /tmp/pgfplots/source/latex/pgfplots/pgfplotstest \( -name 'unittest*.png' -o -name 'unittest*.pdf' \) -delete
	#cd /tmp/pgfplots/source/latex/pgfplots/ && zip --move -r pgfplotstests.zip *
	#cd /tmp/pgfplots/source/context/third/pgfplots/ && zip --move -r pgfplotstests.zip *
	cd /tmp/pgfplots/source/latex/pgfplots/ && tar cjf pgfplotstests.tar.bz2 --remove-files *
	cd /tmp/pgfplots/source/context/third/pgfplots/ && tar cjf pgfplotstests.tar.bz2 --remove-files *
	cd /tmp/pgfplots && zip -r /tmp/$@ *
	cp /tmp/$@ $@
	find `pwd` -maxdepth 1 \( -name '$(@:.zip=)*' \) -ls

$(REVISIONFILE): FORCE
	P=`pwd`; cd pgfplots && echo "`date +%Y-%m-%d` Revision `git describe --tags HEAD`" >$$P/$@

$(CHANGELOG): FORCE
	cp pgfplots/doc/latex/pgfplots/ChangeLog $@

$(README): FORCE
	cp pgfplots/doc/generic/pgfplots/README $@

$(PDF): pgfplots/doc/latex/pgfplots/pgfplots.pdf
	cp $< $@

$(PDFTABLE): pgfplots/doc/latex/pgfplots/pgfplotstable.pdf
	cp $< $@

download:
	scp  ludewich,pgfplots@web.sourceforge.net:htdocs/index.html /tmp || exit 1
	echo "index.html copied to /tmp"

gallery:
	echo "Remaking gallery ... "
	#make -C pgfplots/doc/latex/pgfplots/gallery 
	scp pgfplots/doc/latex/pgfplots/gallery/gallery.{html,css} pgfplots/doc/latex/pgfplots/gallery/example*.png pgfplots/doc/latex/pgfplots/gallery/example*.pdf pgfplots/doc/latex/pgfplots/gallery/example*.tex ludewich,pgfplots@web.sourceforge.net:htdocs/
