# dummy release script
#
# DO NOT invoke this from a pgfplots directory, 
# use 
# make -f pgfplots/scripts/pgfplots/Makefile.pgfplots_release_sourceforge
VERSION=_unstable

ZIP=pgfplots$(VERSION).tds.zip
PDF=pgfplots$(VERSION).pdf
PDFTABLE=pgfplotstable$(VERSION).pdf
CHANGELOG=ChangeLog$(VERSION)
REVISIONFILE=pgfplots$(VERSION).revision

files: zip pdf

all: uploaddist download gallery 

zip: $(ZIP)

pdf: $(PDF) $(PDFTABLE)

revisionfile: $(REVISIONFILE)

uploadindexhtml: /tmp/index.html
	scp $< ludewich,pgfplots@web.sourceforge.net:htdocs/
	

upload: $(ZIP) $(PDF) $(PDFTABLE) $(CHANGELOG) $(REVISIONFILE)
	scp $^ ludewich,pgfplots@web.sourceforge.net:htdocs/

uploaddist: $(ZIP) $(PDF) $(PDFTABLE)
	scp ~/code/tex/pgfplots/doc/latex/pgfplots/pgfplots.pdf \
		~/code/tex/pgfplots/doc/latex/pgfplots/pgfplotstable.pdf \
		ludewich,pgfplots@web.sourceforge.net:htdocs/

FORCE:

pgfplots.tds.zip: FORCE
	rm -fr /tmp/pgfplots /tmp/$@
	cd pgfplots && scripts/pgfplots/pgfplotsrevisionfile.sh
	rsync --copy-links \
		--exclude=.git \
		--exclude='.*.sw?' \
		--exclude='*.aux' \
		--exclude='*.log' \
		--exclude='*~' \
		--exclude='*.bbl' \
		--exclude='*.blg' \
		--exclude='*.idx' \
		--exclude='*.ilg' \
		--exclude='*.log' \
		--exclude='*.ind' \
		--exclude='*.toc' \
		--exclude='*.out' \
		--exclude='*.djs' \
		--exclude='*.tmp' \
		--exclude='*.tuo' \
		--exclude='*.tui' \
		--exclude='*.top' \
		--exclude='*.pgf' \
		--exclude='*.mp' \
		--exclude='.gitignore' \
		--exclude='.cvsignore' \
		--exclude='pgfplotsrevisionfile.sh' \
		--exclude='pgfplots_in_ubuntu.readme.txt' \
		--exclude='pgfplotstable.example1.out.*' \
		--exclude='expensiveexample*' \
		--exclude='Makefile.pgfplots_release_sourceforge' \
		--exclude='pgfplotsDEV_copy_files_from_pgf.sh' \
		-r pgfplots /tmp
	make -C /tmp/pgfplots/doc/latex/pgfplots/gallery/ clean
	cd /tmp/pgfplots/source/latex/pgfplots/ && zip --move -r pgfplotstests.zip *
	cd /tmp/pgfplots/source/context/third/pgfplots/ && zip --move -r pgfplotstests.zip *
	cd /tmp/pgfplots && zip -r /tmp/$@ *
	cp /tmp/$@ $@
	find `pwd` -maxdepth 1 \( -name '$(@:.zip=)*' \) -ls

$(REVISIONFILE): FORCE
	P=`pwd`; cd ~/code/tex/pgfplots && echo "`date +%Y-%m-%d` Revision `git describe --tags HEAD`" >$$P/$@

$(ZIP): pgfplots.tds.zip
	cp $< $@
	cp ~/code/tex/pgfplots/doc/latex/pgfplots/ChangeLog $(CHANGELOG)

$(PDF): ~/code/tex/pgfplots/doc/latex/pgfplots/pgfplots.pdf
	cp $< $@

$(PDFTABLE): ~/code/tex/pgfplots/doc/latex/pgfplots/pgfplotstable.pdf
	cp $< $@

download:
	scp  ludewich,pgfplots@web.sourceforge.net:htdocs/index.html /tmp || exit 1
	echo "index.html copied to /tmp"

gallery:
	echo "Remaking gallery ... "
	#make -C ~/code/tex/pgfplots/doc/latex/pgfplots/gallery 
	scp '~/code/tex/pgfplots/doc/latex/pgfplots/gallery/example*' ludewich,pgfplots@web.sourceforge.net:htdocs/
