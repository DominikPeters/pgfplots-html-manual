\documentclass{article}

\makeatletter
\usepackage{pgf}
\usepgflibrary{luamath}

\begin{document}

X

\def\SHOW#1{%
	\dimen0=#1 %
	#1 = \the\dimen0
}

\SHOW{1pt}

\SHOW{1mm}

\SHOW{1cm}

\SHOW{1in}

\SHOW{1ex}

\SHOW{1em}

\SHOW{1bp}

\SHOW{1pc}

\SHOW{1dd}

\SHOW{1cc}

\SHOW{1sp}

\pgfluamathshowerrormessagetrue
%\tracingmacros=2 \tracingcommands=2

\newcount\numErrors
\def\parsertest#1#2#3{%
	\pgfluamathparse{#1}%
	\let\actual=\pgfluamathresult
	\ifpgfluamathusedTeXfallback
		\let\expectedTeX=\actual
	\else
		%\pgfmathparse{#1}%
		\let\expectedTeX=\pgfmathresult
		% FIXME : support this!
		\let\expectedTeX=\actual
	\fi
	%
	\edef\expected{#2}%
	\def\success{1}%
	\ifx\expected\empty
		\ifx\actual\empty
		\else
			\def\success{0}%
		\fi
	\else
		\ifx\actual\expected
		\else
			\def\success{0}%
		\fi
	\fi
	%
	\if1\success
	\else
		\message{FAILURE for #1 expected \expected\space but was \actual^^J}%
		\advance\numErrors by1
	\fi
	%
	\if1\success
		\if1#3%
			\ifpgfluamathunitsdeclared
			\else
				\def\success{0}%
			\fi
		\else
			\ifpgfluamathunitsdeclared
				\def\success{0}%
			\fi
		\fi
		\if1\success
		\else
			\message{FAILURE for #1 expected units declared #3 but was \ifpgfluamathunitsdeclared true\else false\fi^^J}%
			\advance\numErrors by1
		\fi
	\fi
	%
	\message{#1 = \actual\space (pgf=\expectedTeX) \if1\success OK\else FAILURE\fi^^J}%
}%

\parsertest{1}{1.000000}{0}
\parsertest{  1}{1.000000}{0}
\parsertest{-123}{-123.000000}{0}
\parsertest{+123}{123.000000}{0}
\parsertest{+1.23}{1.230000}{0}
\parsertest{+.123}{0.123000}{0}
\parsertest{1.23}{1.230000}{0}
\parsertest{1.}{1.000000}{0.000000}
\parsertest{0.123}{0.123000}{0}
\parsertest{.123}{0.123000}{0}
\parsertest{1e4}{10000.000000}{0}
\parsertest{1e-4}{0.000100}{0}
\parsertest{1e+4}{10000.000000}{0}
\parsertest{1Y1.23e4]}{12300.000000}{0}
\parsertest{1.23e-004}{0.000123}{0}
\parsertest{004}{4.000000}{0}
\parsertest{1 + 10}{11.000000}{0}
\parsertest{1 - 10}{-9.000000}{0}
\parsertest{(1)}{1.000000}{0}
\parsertest{3 + 5*9 / (1+1) - 12}{13.500000}{0}
\parsertest{pi}{3.141593}{0}
\parsertest{sin(0)}{0.000000}{0}
\parsertest{sin(90)}{1.000000}{0}
\parsertest{cos(90)}{0.000000}{0}
\parsertest{pow(2,3)}{8.000000}{0}
\parsertest{-pow(2,3)}{-8.000000}{0}
\parsertest{-pi}{-3.141593}{0}
\parsertest{inf}{inf}{0}
\parsertest{INF}{inf}{0}
\parsertest{not(100)}{0.000000}{0} -- non-trivial since the function is pgfluamathfunctions.notPGF
\parsertest{2^2}{4.000000}{0}
\parsertest{1Y2.0e0]^2}{4.000000}{0}
\parsertest{0-2^2}{-4.000000}{0}
\parsertest{-2^2}{-4.000000}{0}
\parsertest{pi^2}{9.869604}{0}
\parsertest{2^2+2}{6.000000}{0}
\parsertest{2^2-1}{3.000000}{0}
\parsertest{-1 + 4}{3.000000}{0}
\parsertest{2^2*5}{20.000000}{0}
\parsertest{2^(2+2)}{16.000000}{0}
\parsertest{multiply(2,3)^2}{36.000000}{0}
\parsertest{(2+3)^2}{25.000000}{0}
\parsertest{(2 + 3 ) ^ 2}{25.000000}{0}
\parsertest{2^add(1,1)}{4.000000}{0}
\parsertest{3!}{6.000000}{0}
\parsertest{1+3!}{7.000000}{0}
\parsertest{2*3!}{12.000000}{0}
\parsertest{3! + 1}{7.000000}{0}
\parsertest{3 !}{6.000000}{0}
\parsertest{3*2+4}{10.000000}{0}
\directlua{
function pgfluamathfunctions.x()
	return 4
end
function pgfluamathfunctions.xx()
	return 60
end
function pgfluamathfunctions.y()
	return 60
end
function pgfluamathfunctions.N1(x,m,n)
	return x+m+n
end
}
\parsertest{2^x}{16.000000}{0}
\parsertest{exp(-x^2)}{0.000000}{0} % requires output format=fpu
\parsertest{N1(1,2,3)}{6.000000}{0}
\parsertest{ 1 + 2 * 4 ^ 2 }{33.000000}{0}
\parsertest{-x + 4}{0.000000}{0}
\parsertest{-x * 4}{-16.000000}{0}
\parsertest{-x * - 4}{16.000000}{0}
\parsertest{2*pi r}{360.000000}{0}
\parsertest{6.28318530717959 r}{360.000000}{0}
\parsertest{sin(2*pi r)}{-0.000000}{0}
\parsertest{1.5707963267949r + 1.5707963267949r}{180.000000}{0}
\parsertest{1 ? 42 : 0}{42.000000}{0}
\parsertest{-1 + 1 ? 42 : 0}{0.000000}{0}
\parsertest{1 + (1 ? 42 : 0)}{43.000000}{0}
\parsertest{1 ? 42 : 0 ? 5 : 6}{5.000000}{0}
\parsertest{(1 ? 42 : 0) ? 5 : 6}{5.000000}{0}
\parsertest{43 == 43}{1.000000}{0}
\parsertest{43 == 42}{0.000000}{0}
\parsertest{43 != 43}{0.000000}{0}
\parsertest{43 != 42}{1.000000}{0}
\parsertest{43 > 42}{1.000000}{0}
\parsertest{43 > 44}{0.000000}{0}
\parsertest{43 < 42}{0.000000}{0}
\parsertest{43 < 44}{1.000000}{0}
\parsertest{43 <= 44}{1.000000}{0}
\parsertest{43 >= 44}{0.000000}{0}
\parsertest{43 >= 44 == 1}{0.000000}{0}
\parsertest{!1}{0.000000}{0}
\parsertest{! 1}{0.000000}{0}
\parsertest{! -1}{0.000000}{0}
\parsertest{--1}{1.000000}{0}
\parsertest{! !1}{1.000000}{0}
\parsertest{3! - !0}{5.000000}{0}
\parsertest{1 && 1 }{1.000000}{0}
\parsertest{1 && 0 || 1 }{1.000000}{0}
\parsertest{1 && 0 && 1 }{0.000000}{0}
\parsertest{1 || 0 }{1.000000}{0}
\parsertest{0 || 0 || 1 }{1.000000}{0}


\parsertest{1pt}{1.000000}{1}
\parsertest{1mm}{2.845261}{1}
\parsertest{1cm}{28.452744}{1}
\parsertest{1in}{72.269989}{1}
\parsertest{1ex}{4.305542}{1}
\parsertest{1em}{10.000015}{1}
\parsertest{1bp}{1.003738}{1}
\parsertest{1dd}{1.070007}{1}
\parsertest{1cc}{12.840103}{1}
\parsertest{1sp}{0.000015}{1}
\parsertest{1pc}{12.000000}{1}
% these TeX macros must be defined and set, of course!



\count1=43
\parsertest{\count1}{43.000000}{0}
%
\newdimen\luamathparse@dimen
\luamathparse@dimen=42pt
\parsertest{1*\luamathparse@dimen}{42.000000}{1}
%
\newcount\luamathparse@count
\luamathparse@count=42
\parsertest{1*\luamathparse@count}{42.000000}{0}
%
\setbox0=\hbox{1233}
\parsertest{\wd0}{20.000061}{1}
\parsertest{\ht0}{6.444443}{1}
\parsertest{\dp0}{0.000000}{1}

%--------------------------------------------------
% if false then
% -- arrays created via '{}' and indexed with '[]'
% -- strings with "<str>"
% -- 'scalar' function
% -- trig format
% -- hex/octal/binary input
% -- tex registers 
% -- What happens for undefined functions!? --> return nil and let TeX invoke its parser (no warning!?)
% -- width/height/depth
% end
%-------------------------------------------------- 

\ifnum\numErrors>0
	\PackageError{pgf}{Has \the\numErrors\space FAILURES}{}
\else
	\message{All cases PASSED^^J}%
\fi


\end{document}
