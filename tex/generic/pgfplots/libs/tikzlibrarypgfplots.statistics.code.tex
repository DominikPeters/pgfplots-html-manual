%--------------------------------------------
%
% Package pgfplots, library for statistical plots (boxplots in the first version)
%
% Copyright 2007-2012 by Christian Feuers√§nger.
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%
%--------------------------------------------

\newif\ifpgfplotsplothandlerboxplot@variable@width

\pgfplotsset{
	boxplot prepared/.code={%
		\def\tikz@plot@handler{\pgfplotsplothandlerboxplotprepared}%
		\pgfkeysalso{%
			/pgfplots/every boxplot,
			/pgfplots/boxplot/.cd,
			#1%
		}%
	},
	boxplot/data value/.code	=\pgfplots@set@source@for{boxplot/data}{#1}{0},%
	boxplot/data/.code			=\pgfplots@set@source@for{boxplot/data}{#1}{1},%
	boxplot/data filter/.code=,
	boxplot/data value=\pgfkeysvalueof{/data point/y},
	%
	every boxplot/.style={%
	},
	boxplot/median/.initial=,
	boxplot/lower quartile/.initial=,
	boxplot/upper quartile/.initial=,
	boxplot/lower whisker/.initial=,
	boxplot/upper whisker/.initial=,
	boxplot/average/.initial=,
	%
	%
	% the size of whisker lines in axis units.
	% The default is to make it relative to 'box length'
	boxplot/whisker length/.initial=\pgfkeysvalueof{/pgfplots/boxplot/box length}*0.8,
	%
	% the size of the box in axis units. Note that this has been
	% chosen to fit the initial 'draw position':
	boxplot/box length/.initial=0.8,
	% draw direction=x|y
	boxplot/draw direction/.initial=x,	
	%
	boxplot/variable width/.is if=pgfplotsplothandlerboxplot@variable@width,
	% only used if 'variable width=true'
	boxplot/variable width key/.initial=,
	% will be computed automatically if needed:
	boxplot/variable width key min/.initial=,
	boxplot/variable width key max/.initial=,
	%
	% this factor times 'box length' is the size for 
	% 'variable width key min'. The max value gets 'box length'.
	boxplot/variable width min target/.initial=0.2,
	%
	%
	% defines where how the "free" position is chosen. The idea is to
	% place one box at each "y" position and to number these
	% 1,2,3,4,... . This should probably simplify tick (label) generation.
	boxplot/draw position/.initial=1+\plotnumofactualtype,
	%
	% draw relative anchor=0:  
	%     |    |---|  |
	%     |    |   |  |
	%     |----|---|--|
	%
	% draw relative anchor=0.5:
	%     |    |---|  |
	%     |----|   |--|
	%     |    |---|  |
	%
	% draw relative anchor=1:  
	%     |----|---|--|
	%     |    |   |  |
	%     |    |---|  |
	boxplot/draw relative anchor/.initial=0.5,
	%
	boxplot/every whisker/.style={%
	},
	boxplot/every box/.style={%
	},
	boxplot/every median/.style={%
	},
	boxplot/every average/.style={%
		/tikz/only marks, /tikz/mark=diamond*,
	},
	boxplot/draw/lower whisker/.style={%
		/pgfplots/boxplot/draw/whisker=%
			{\pgfkeysvalueof{/pgfplots/boxplot/lower quartile}}
			{\pgfkeysvalueof{/pgfplots/boxplot/lower whisker}}
	},
	boxplot/draw/upper whisker/.style={%
		/pgfplots/boxplot/draw/whisker=%
			{\pgfkeysvalueof{/pgfplots/boxplot/upper quartile}}
			{\pgfkeysvalueof{/pgfplots/boxplot/upper whisker}}%
	},
	boxplot/draw/whisker/.code 2 args={%
		\draw[/pgfplots/boxplot/every whisker/.try]
			(boxplot cs:#1) -- (boxplot cs:#2)
			(boxplot cs:#2,{\pgfplots@boxplot@anchor@value@whisker{0}})
			--
			(boxplot cs:#2,{\pgfplots@boxplot@anchor@value@whisker{1}})
		;
	},%
	%
	boxplot/draw/box/.code={%
		\draw[/pgfplots/boxplot/every box/.try]
			(boxplot cs:\pgfkeysvalueof{/pgfplots/boxplot/lower quartile},{\pgfplots@boxplot@anchor@value{0}})
			rectangle
			(boxplot cs:\pgfkeysvalueof{/pgfplots/boxplot/upper quartile},{\pgfplots@boxplot@anchor@value{1}})
		;
	},%
	%
	boxplot/draw/average/.code={%
		\draw[/pgfplots/boxplot/every average/.try]
			\pgfextra
			\pgftransformshift{%
				\pgfplotsboxplotpointab
					{\pgfkeysvalueof{/pgfplots/boxplot/average}}
					{\pgfplots@boxplot@anchor@value{0.5}}%
			}%
			\pgfuseplotmark{\tikz@plot@mark}%
			\endpgfextra
		;
	},
	%
	boxplot/draw/median/.code={%
		\draw[/pgfplots/boxplot/every median/.try]
			(boxplot cs:\pgfkeysvalueof{/pgfplots/boxplot/median},{\pgfplots@boxplot@anchor@value{0}})
			--
			(boxplot cs:\pgfkeysvalueof{/pgfplots/boxplot/median},{\pgfplots@boxplot@anchor@value{1}})
		;
	},%
}

% A helper which implements 'draw relative anchor'. It expands to a
% math expression which is suitable as second argument for 'boxplot cs';
% i.e. it needs to be added to 'boxplot/draw position'.
% 
% More precisely, this macro is to be used in a context where lines of
% 'box length' length have to be drawn.
%
% The argument is shifted by 'draw relative anchor' and is scaled by
% 'box length'.
%
% #1: the coordinate. 0 is the means "lower part of the construct
% which is to be drawn". 1 means the "upper part of that construct"
% and 0.5 is in the middle. 
\def\pgfplots@boxplot@anchor@value#1{%
	(#1-\pgfkeysvalueof{/pgfplots/boxplot/draw relative anchor})*\pgfkeysvalueof{/pgfplots/boxplot/box length}%
}

% same as \pgfplots@boxplot@anchor@value, but for drawing constructs
% which are at most 'whisker length' long.
\def\pgfplots@boxplot@anchor@value@whisker#1{%
	(#1-\pgfkeysvalueof{/pgfplots/boxplot/draw relative anchor})*\pgfkeysvalueof{/pgfplots/boxplot/whisker length}%
}

\def\pgfplotsplothandlerboxplotprepared{%
	\ifpgfplots@stackedmode
		\pgfplotsthrow{unsupported operation}{Sorry, 'stacked plots' are currently unsupported for box plots. See the manual for 'boxplot/draw position' for how to achieve the effect (using \string\plotnumofactualtype)}\pgfeov
	\else
		\pgfplotsplothandlerboxplotprepared@
	\fi
}
\def\pgfplotsplothandlerboxplotprepared@{%
	\pgfplotsresetplothandler
	%
	\def\pgfplotsplothandlername{boxplot prepared}%
	%
	\let\pgf@plotstreamstart=\pgfplotsplothandlervisstart@boxplot@prepared
	\let\pgfplotsplothandlersurveystart=\pgfplotsplothandlersurveystart@boxplot@prepared
	\let\pgfplotsplothandlersurveypoint=\pgfplotsplothandlersurveypoint@boxplot@prepared
	\let\pgfplotsplothandlersurveyend=\pgfplotsplothandlersurveyend@boxplot@prepared
	%
	\pgfkeysgetvalue{/pgfplots/boxplot/draw direction}\pgfplots@loc@TMPa
	\if x\pgfkeysvalueof{/pgfplots/boxplot/draw direction}%
	\else
		\if y\pgfkeysvalueof{/pgfplots/boxplot/draw direction}%
		\else
			\pgfplotsthrow{invalid argument}{\pgfplots@loc@TMPa}{Invalid choice boxplot/draw direction=\pgfplots@loc@TMPa}\pgfeov%
			\def\pgfplots@loc@TMPa{x}%
		\fi
	\fi
	\csname pgfplotsplothandlerboxplotprepared@setxy@\pgfplots@loc@TMPa\endcsname
	%
	\def\pgfplotsboxplotpointab##1##2{%
		\begingroup
			\pgfkeys{/pgf/fpu}%
			\pgfmathparse{##1}%
			\let\pgfplotsplothandlerboxplot@@=\pgfmathresult
			\pgfmathparse{\pgfkeysvalueof{/pgfplots/boxplot/draw position} + ##2}%
			\xdef\pgfplots@glob@TMPa{{\pgfplotsplothandlerboxplot@@}{\pgfmathresult}}%
			\expandafter\pgfplotsboxplotpointab@\pgfplots@glob@TMPa{\pgfplotspointaxisxy}%
			\pgf@process{}%
		\endgroup
	}%
	\def\pgfplotsboxplotpointab@survey##1##2{%
		\edef\pgfmathresult{##1}%
		\ifx\pgfmathresult\pgfutil@empty
		\else
			\pgfmathparse{\pgfmathresult}%
		\fi
		\let\pgfplotsplothandlerboxplot@@=\pgfmathresult
		\pgfmathparse{\pgfkeysvalueof{/pgfplots/boxplot/draw position} + ##2}%
		\xdef\pgfplots@glob@TMPa{{\pgfplotsplothandlerboxplot@@}{\pgfmathresult}}%
		\let\pgfplotsplothandlerboxplot@modified@draw@position=\pgfmathresult%
		\expandafter\pgfplotsboxplotpointab@\pgfplots@glob@TMPa{\pgfplotsboxplotpointab@@define@current@xy}%
	}%
}%

\def\pgfplotsboxplotpointab@@define@current@xy#1#2{%
	\edef\pgfplots@current@point@x{#1}%
	\edef\pgfplots@current@point@y{#2}%
}%

\def\pgfplotsplothandlerboxplotprepared@setxy@x{%
	\def\pgfplotsboxplotpointab@##1##2##3{%
		##3{##1}{##2}%
	}%
}%
\def\pgfplotsplothandlerboxplotprepared@setxy@y{%
	\def\pgfplotsboxplotpointab@##1##2##3{%
		##3{##2}{##1}%
	}%
}%

\def\pgfplotsplothandlersurveypoint@boxplot@collect@limits{%
	\pgfplotsaxisparsecoordinate
	\pgfplotsaxispreparecoordinate
	\ifpgfplotsaxisparsecoordinateok
		\pgfplotsaxisupdatelimitsforcoordinate\pgfplots@current@point@x\pgfplots@current@point@y\pgfplots@current@point@z
	\fi
	%
	% do NOT store the processed coordinate! the coordinate stream
	% is ONLY for outliers.
	%
	% ... but update this stuff to avoid a "plot without coordinates"
	% case
	\pgfplotscoordstream@firstlast@update
}

\def\pgfplotsplothandlersurveystart@boxplot@prepared{%
	\pgfplots@prepare@source@parser@for{boxplot/}{data}{\pgfplotsplothandlerboxplot@parse}%
	%
	\pgfplotsplothandlersurveystart@default
}

\def\pgfplotsplothandlersurveypoint@boxplot@prepared{%
	% seems the "parse" routine is stupid ... the /data point/ stuff
	% is redefined although it should not. Strange...
	\pgfkeyslet{/data point/x}\pgfplots@current@point@x
	\pgfkeyslet{/data point/y}\pgfplots@current@point@y
	\pgfkeyslet{/data point/z}\pgfplots@current@point@z
	\pgfplotsplothandlerboxplot@parse
	%
	\pgfplotsboxplotpointab@survey{\pgfmathresult}{0}%
	%
	\pgfplotsplothandlersurveypoint@default
}

\def\pgfplotsplothandlersurveyend@boxplot@prepared{%
	\let\pgfplots@invoke@filter@xyz@old=\pgfplots@invoke@filter@xyz
	\let\pgfplots@invoke@filter@xyz=\relax
	\let\pgfplots@invoke@filter@old=\pgfplots@invoke@filter
	\def\pgfplots@invoke@filter##1##2{}%
	\let\pgfplots@invoke@prefilter@old=\pgfplots@invoke@prefilter
	\let\pgfplots@invoke@prefilter=\relax
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/lower whisker}}
		{\pgfplots@boxplot@anchor@value@whisker{0}}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/lower whisker}}
		{\pgfplots@boxplot@anchor@value@whisker{1}}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/lower quartile}}%
		{\pgfplots@boxplot@anchor@value{0}}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/lower quartile}}%
		{\pgfplots@boxplot@anchor@value{1}}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/median}}
		{\pgfplots@boxplot@anchor@value0}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/median}}
		{\pgfplots@boxplot@anchor@value1}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/average}}
		{\pgfplots@boxplot@anchor@value0}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/average}}
		{\pgfplots@boxplot@anchor@value1}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/upper quartile}}%
		{\pgfplots@boxplot@anchor@value0}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/upper quartile}}%
		{\pgfplots@boxplot@anchor@value1}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	%
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/upper whisker}}%
		{\pgfplots@boxplot@anchor@value@whisker1}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/upper whisker}}%
		{\pgfplots@boxplot@anchor@value@whisker0}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	\let\pgfplots@invoke@prefilter=\pgfplots@invoke@prefilter@old
	\let\pgfplots@invoke@filter=\pgfplots@invoke@filter@old
	\let\pgfplots@invoke@filter@xyz=\pgfplots@invoke@filter@xyz@old
	%
	\pgfplotsplothandlersurveyend@default
}%

%--------------------------------------------------
% \def\pgfplotsplothandlerboxplot@variable@width{%
% 	\pgfkeysgetvalue{/pgfplots/boxplot/variable width key min}\pgfmathresult
% 	\edef\pgfplotsplothandlerboxplot@widthkey@min{\pgfmathresult}%
% 	%
% 	\pgfkeysgetvalue{/pgfplots/boxplot/variable width key max}\pgfmathresult
% 	\edef\pgfplotsplothandlerboxplot@widthkey@max{\pgfmathresult}%
% 	%
% 	\ifx\pgfplotsplothandlerboxplot@widthkey@min\pgfutil@empty
% 		\pgfplotscoordmath{default}{max}%
% 		\let\pgfplotsplothandlerboxplot@widthkey@min=\pgfmathresult
% 		\def\pgfplotsplothandlerboxplot@widthkey@min@autocompute{1}%
% 	\else
% 		\pgfmathfloatparsenumber{\pgfplotsplothandlerboxplot@widthkey@min}%
% 		\let\pgfplotsplothandlerboxplot@widthkey@min=\pgfmathresult
% 		\def\pgfplotsplothandlerboxplot@widthkey@min@autocompute{0}%
% 	\fi
% 	\ifx\pgfplotsplothandlerboxplot@widthkey@max\pgfutil@empty
% 		\pgfplotscoordmath{default}{min}%
% 		\let\pgfplotsplothandlerboxplot@widthkey@max=\pgfmathresult
% 		\def\pgfplotsplothandlerboxplot@widthkey@max@autocompute{1}%
% 	\else
% 		\pgfmathfloatparsenumber{\pgfplotsplothandlerboxplot@widthkey@max}%
% 		\let\pgfplotsplothandlerboxplot@widthkey@max=\pgfmathresult
% 		\def\pgfplotsplothandlerboxplot@widthkey@max@autocompute{0}%
% 	\fi
% }%
%-------------------------------------------------- 

\def\pgfplotsplothandlervisstart@boxplot@prepared{%
	%
	\global\let\pgf@plotstreampoint=\pgfutil@gobble
	\global\let\pgf@plotstreamspecial=\pgfutil@gobble%
	\global\let\pgf@plotstreamend=\relax
	%
	\pgfplotsplothandlervisstart@boxplot@prepared@draw
}%

\def\pgfplotsplothandlervisstart@boxplot@prepared@draw{%
	\def\b@pgfplots@boxplot@hasbox{1}%
	\edef\pgfplots@loc@TMPa{\pgfkeysvalueof{/pgfplots/boxplot/lower quartile}}%
	\ifx\pgfplots@loc@TMPa\pgfutil@empty
		\def\b@pgfplots@boxplot@hasbox{0}%
	\fi
	\edef\pgfplots@loc@TMPa{\pgfkeysvalueof{/pgfplots/boxplot/upper quartile}}%
	\ifx\pgfplots@loc@TMPa\pgfutil@empty
		\def\b@pgfplots@boxplot@hasbox{0}%
	\fi
	%
	\if0\b@pgfplots@boxplot@hasbox
		% hm. we have no box. Very strange boxplot, I'd say.
		%
		% But anyway: if someone has whiskers without box,
		% short-circuit the whiskers:
		\edef\pgfplots@loc@TMPa{\pgfkeysvalueof{/pgfplots/boxplot/lower whisker}}%
		\edef\pgfplots@loc@TMPb{\pgfkeysvalueof{/pgfplots/boxplot/upper whisker}}%
		\pgfkeyslet{/pgfplots/boxplot/lower quartile}\pgfplots@loc@TMPb
		\pgfkeyslet{/pgfplots/boxplot/upper quartile}\pgfplots@loc@TMPa
	\fi
	%
	%
	\edef\pgfplots@loc@TMPa{\pgfkeysvalueof{/pgfplots/boxplot/lower whisker}}%
	\ifx\pgfplots@loc@TMPa\pgfutil@empty
	\else
		\pgfkeysvalueof{/pgfplots/boxplot/draw/lower whisker/.@cmd}\pgfeov
	\fi
	%
	\edef\pgfplots@loc@TMPa{\pgfkeysvalueof{/pgfplots/boxplot/upper whisker}}%
	\ifx\pgfplots@loc@TMPa\pgfutil@empty
	\else
		\pgfkeysvalueof{/pgfplots/boxplot/draw/upper whisker/.@cmd}\pgfeov
	\fi
	%
	\if1\b@pgfplots@boxplot@hasbox
		\pgfkeysvalueof{/pgfplots/boxplot/draw/box/.@cmd}\pgfeov
	\fi
	%
	\edef\pgfplots@loc@TMPa{\pgfkeysvalueof{/pgfplots/boxplot/median}}%
	\ifx\pgfplots@loc@TMPa\pgfutil@empty
	\else
		\pgfkeysvalueof{/pgfplots/boxplot/draw/median/.@cmd}\pgfeov
	\fi
	%
	\edef\pgfplots@loc@TMPa{\pgfkeysvalueof{/pgfplots/boxplot/average}}%
	\ifx\pgfplots@loc@TMPa\pgfutil@empty
	\else
		\pgfkeysvalueof{/pgfplots/boxplot/draw/average/.@cmd}\pgfeov
	\fi
}%

\tikzdeclarecoordinatesystem{boxplot}{%
	\edef\pgfplots@loc@TMPa{#1}%
	\expandafter\pgfutil@in@\expandafter,\expandafter{\pgfplots@loc@TMPa}%
	\ifpgfutil@in@
		\def\pgfplots@loc@TMPb##1,##2\pgfplots@EOI{%
			\def\pgfplots@boxplotcs@a{##1}%
			\def\pgfplots@boxplotcs@b{##2}%
		}%
		\expandafter\pgfplots@loc@TMPb\pgfplots@loc@TMPa\pgfplots@EOI
	\else
		\let\pgfplots@boxplotcs@a=\pgfplots@loc@TMPa%
		\def\pgfplots@boxplotcs@b{0}%
	\fi
	\pgfplotsboxplotpointab{\pgfplots@boxplotcs@a}{\pgfplots@boxplotcs@b}%
}%
\endinput
