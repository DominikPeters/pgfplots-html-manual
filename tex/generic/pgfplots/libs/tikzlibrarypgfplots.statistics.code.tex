%--------------------------------------------
%
% Package pgfplots, library for statistical plots (boxplots in the first version)
%
% Copyright 2007-2012 by Christian Feuers√§nger.
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%
%--------------------------------------------

\pgfplotsset{
	boxplot prepared/.code={%
		\def\tikz@plot@handler{\pgfplotsplothandlerboxplotprepared}%
		\pgfkeysalso{%
			/pgfplots/every boxplot,
			/pgfplots/boxplot/.cd,
			#1%
		}%
	},
	every boxplot/.style={%
	},
	boxplot/median/.initial=,
	boxplot/lower quartile/.initial=,
	boxplot/upper quartile/.initial=,
	boxplot/lower whisker/.initial=,
	boxplot/upper whisker/.initial=,
	%
	%
	boxplot/whisker length/.initial=0.8,
	boxplot/box length/.initial=1,
	% draw direction=x|y
	boxplot/draw direction/.initial=x,	
	boxplot/draw position/.initial=1,
	%
	% draw relative anchor=0:  
	%     |    |---|  |
	%     |    |   |  |
	%     |----|---|--|
	%
	% draw relative anchor=0.5:
	%     |    |---|  |
	%     |----|   |--|
	%     |    |---|  |
	%
	% draw relative anchor=1:  
	%     |----|---|--|
	%     |    |   |  |
	%     |    |---|  |
	boxplot/draw relative anchor/.initial=0.5,
	%
	boxplot/every whisker/.style={%
	},
	boxplot/every box/.style={%
	},
	boxplot/every median/.style={%
	},
	boxplot/draw/lower whisker/.style={%
		/pgfplots/boxplot/draw/whisker=%
			{\pgfkeysvalueof{/pgfplots/boxplot/lower quartile}}
			{\pgfkeysvalueof{/pgfplots/boxplot/lower whisker}}
	},
	boxplot/draw/upper whisker/.style={%
		/pgfplots/boxplot/draw/whisker=%
			{\pgfkeysvalueof{/pgfplots/boxplot/upper quartile}}
			{\pgfkeysvalueof{/pgfplots/boxplot/upper whisker}}%
	},
	boxplot/draw/whisker/.code 2 args={%
		\draw[/pgfplots/boxplot/every whisker/.try]
			(boxplot cs:#1) -- (boxplot cs:#2)
			(boxplot cs:#2,{\pgfplots@boxplot@anchor@value@whisker{0}})
			--
			(boxplot cs:#2,{\pgfplots@boxplot@anchor@value@whisker{1}})
		;
	},%
	%
	boxplot/draw/box/.code={%
		\draw[/pgfplots/boxplot/every box/.try]
			(boxplot cs:\pgfkeysvalueof{/pgfplots/boxplot/lower quartile},{\pgfplots@boxplot@anchor@value{0}})
			rectangle
			(boxplot cs:\pgfkeysvalueof{/pgfplots/boxplot/upper quartile},{\pgfplots@boxplot@anchor@value{1}})
		;
	},%
	%
	boxplot/draw/median/.code={%
		\draw[/pgfplots/boxplot/every median/.try]
			(boxplot cs:\pgfkeysvalueof{/pgfplots/boxplot/median},{\pgfplots@boxplot@anchor@value{0}})
			--
			(boxplot cs:\pgfkeysvalueof{/pgfplots/boxplot/median},{\pgfplots@boxplot@anchor@value{1}})
		;
	},%
}

% A helper which implements 'draw relative anchor'. It expands to a
% math expression which is suitable as second argument for 'boxplot cs';
% i.e. it needs to be added to 'boxplot/draw position'.
% 
% More precisely, this macro is to be used in a context where lines of
% 'box length' length have to be drawn.
%
% The argument is shifted by 'draw relative anchor' and is scaled by
% 'box length'.
%
% #1: the coordinate. 0 is the means "lower part of the construct
% which is to be drawn". 1 means the "upper part of that construct"
% and 0.5 is in the middle. 
\def\pgfplots@boxplot@anchor@value#1{%
	(#1-\pgfkeysvalueof{/pgfplots/boxplot/draw relative anchor})*\pgfkeysvalueof{/pgfplots/boxplot/box length}%
}

% same as \pgfplots@boxplot@anchor@value, but for drawing constructs
% which are at most 'whisker length' long.
\def\pgfplots@boxplot@anchor@value@whisker#1{%
	(#1-\pgfkeysvalueof{/pgfplots/boxplot/draw relative anchor})*\pgfkeysvalueof{/pgfplots/boxplot/whisker length}%
}

\def\pgfplotsplothandlerboxplotprepared{%
	\pgfplotsresetplothandler
	\let\pgf@plotstreamstart=\pgfplotsplothandlervisstart@boxplot@prepared
	\let\pgfplotsplothandlersurveyend=\pgfplotsplothandlersurveyend@boxplot@prepared
	%
	\pgfkeysgetvalue{/pgfplots/boxplot/draw position}\pgfplotsplothandlerboxplotprepared@drawposition
	\edef\pgfplotsplothandlerboxplotprepared@drawposition{\pgfplotsplothandlerboxplotprepared@drawposition}%
	%
	%
	\pgfkeysgetvalue{/pgfplots/boxplot/draw direction}\pgfplots@loc@TMPa
	\if x\pgfkeysvalueof{/pgfplots/boxplot/draw direction}%
	\else
		\if y\pgfkeysvalueof{/pgfplots/boxplot/draw direction}%
		\else
			\pgfplotsthrow{invalid argument}{\pgfplots@loc@TMPa}{Invalid choice boxplot/draw direction=\pgfplots@loc@TMPa}\pgfeov%
			\def\pgfplots@loc@TMPa{x}%
		\fi
	\fi
	\csname pgfplotsplothandlerboxplotprepared@setxy@\pgfplots@loc@TMPa\endcsname
	%
	\def\pgfplotsboxplotpointab##1##2{%
		\begingroup
			\pgfkeys{/pgf/fpu}%
			\pgfmathparse{##1}%
			\let\pgfplotsplothandlerboxplot@@=\pgfmathresult
			\pgfmathparse{\pgfkeysvalueof{/pgfplots/boxplot/draw position} + ##2}%
			\xdef\pgfplots@glob@TMPa{{\pgfplotsplothandlerboxplot@@}{\pgfmathresult}}%
			\expandafter\pgfplotsboxplotpointab@\pgfplots@glob@TMPa{\pgfplotspointaxisxy}%
			\pgf@process{}%
		\endgroup
	}%
	\def\pgfplotsboxplotpointab@survey##1##2{%
		\pgfmathparse{##1}%
		\let\pgfplotsplothandlerboxplot@@=\pgfmathresult
		\pgfmathparse{\pgfkeysvalueof{/pgfplots/boxplot/draw position} + ##2}%
		\xdef\pgfplots@glob@TMPa{{\pgfplotsplothandlerboxplot@@}{\pgfmathresult}}%
		\let\pgfplotsplothandlerboxplot@modified@draw@position=\pgfmathresult%
		\expandafter\pgfplotsboxplotpointab@\pgfplots@glob@TMPa{\pgfplotsboxplotpointab@@define@current@xy}%
	}%
}%

\def\pgfplotsboxplotpointab@@define@current@xy#1#2{%
	\edef\pgfplots@current@point@x{#1}%
	\edef\pgfplots@current@point@y{#2}%
}%

\def\pgfplotsplothandlerboxplotprepared@setxy@x{%
	\def\pgfplotsboxplotpointab@##1##2##3{%
		##3{##1}{##2}%
	}%
}%
\def\pgfplotsplothandlerboxplotprepared@setxy@y{%
	\def\pgfplotsboxplotpointab@##1##2##3{%
		##3{##2}{##1}%
	}%
}%

\def\pgfplotsplothandlersurveypoint@boxplotprepared{%
	\pgfplotsaxisparsecoordinate
	\pgfplotsaxispreparecoordinate
	\ifpgfplotsaxisparsecoordinateok
		\pgfplotsaxisupdatelimitsforcoordinate\pgfplots@current@point@x\pgfplots@current@point@y\pgfplots@current@point@z
	\fi
	% FIXME : that should not be done ... conflicts with markers.
	%\pgfplotsaxisdatapointsurveyed
}

\def\pgfplotsplothandlersurveyend@boxplot@prepared{%
	% FIXME : make sure we get that outliers receive their correct y value
	% FIXME : remember the correct y value for the visualization
	\let\pgfplots@invoke@filter@xyz@old=\pgfplots@invoke@filter@xyz
	\let\pgfplots@invoke@filter@xyz=\relax
	\let\pgfplots@invoke@filter@old=\pgfplots@invoke@filter
	\def\pgfplots@invoke@filter##1##2{}%
	\let\pgfplots@invoke@prefilter@old=\pgfplots@invoke@prefilter
	\let\pgfplots@invoke@prefilter=\relax
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/lower whisker}}
		{\pgfplots@boxplot@anchor@value@whisker{0}}%
	\pgfplotsplothandlersurveypoint@boxplotprepared
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/lower whisker}}
		{\pgfplots@boxplot@anchor@value@whisker{1}}%
	\pgfplotsplothandlersurveypoint@boxplotprepared
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/lower quartile}}%
		{\pgfplots@boxplot@anchor@value{0}}%
	\pgfplotsplothandlersurveypoint@boxplotprepared
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/lower quartile}}%
		{\pgfplots@boxplot@anchor@value{1}}%
	\pgfplotsplothandlersurveypoint@boxplotprepared
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/median}}
		{0}% does not matter - we have lower and upper bound anyway.
	\pgfplotsplothandlersurveypoint@boxplotprepared
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/upper quartile}}%
		{0}% does not matter - we have lower and upper bound anyway.
	\pgfplotsplothandlersurveypoint@boxplotprepared
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/upper whisker}}%
		{0}% does not matter - we have lower and upper bound anyway.
	\pgfplotsplothandlersurveypoint@boxplotprepared
	%
	\edef\pgfplots@loc@TMPa{/pgfplots/boxplot/draw position=\pgfplotsplothandlerboxplot@modified@draw@position}%
	\expandafter\pgfplotsplothandlersurveyaddoptions\expandafter{\pgfplots@loc@TMPa}%
	%
	\let\pgfplots@invoke@prefilter=\pgfplots@invoke@prefilter@old
	\let\pgfplots@invoke@filter=\pgfplots@invoke@filter@old
	\let\pgfplots@invoke@filter@xyz=\pgfplots@invoke@filter@xyz@old
}%

\def\pgfplotsplothandlervisstart@boxplot@prepared{%
	%
	\global\let\pgf@plotstreampoint=\pgfutil@gobble
	\global\let\pgf@plotstreamspecial=\pgfutil@gobble%
	\global\let\pgf@plotstreamend=\relax
	%
	\pgfplotsplothandlervisstart@boxplot@prepared@draw
}%

\def\pgfplotsplothandlervisstart@boxplot@prepared@draw{%
	%
	\pgfkeysvalueof{/pgfplots/boxplot/draw/lower whisker/.@cmd}\pgfeov
	\pgfkeysvalueof{/pgfplots/boxplot/draw/upper whisker/.@cmd}\pgfeov
	%
	\pgfkeysvalueof{/pgfplots/boxplot/draw/box/.@cmd}\pgfeov
	%
	\pgfkeysvalueof{/pgfplots/boxplot/draw/median/.@cmd}\pgfeov
}%

\tikzdeclarecoordinatesystem{boxplot}{%
	\edef\pgfplots@loc@TMPa{#1}%
	\expandafter\pgfutil@in@\expandafter,\expandafter{\pgfplots@loc@TMPa}%
	\ifpgfutil@in@
		\def\pgfplots@loc@TMPb##1,##2\pgfplots@EOI{%
			\def\pgfplots@boxplotcs@a{##1}%
			\def\pgfplots@boxplotcs@b{##2}%
		}%
		\expandafter\pgfplots@loc@TMPb\pgfplots@loc@TMPa\pgfplots@EOI
	\else
		\let\pgfplots@boxplotcs@a=\pgfplots@loc@TMPa%
		\def\pgfplots@boxplotcs@b{0}%
	\fi
	\pgfplotsboxplotpointab{\pgfplots@boxplotcs@a}{\pgfplots@boxplotcs@b}%
}%
\endinput
