%--------------------------------------------
%
% Package pgfplots, library for statistical plots (boxplots in the first version)
%
% Copyright 2007-2012 by Christian Feuers√§nger.
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%
%--------------------------------------------


\pgfplotsset{
	boxplot/.code={%
		\def\tikz@plot@handler{\pgfplotsplothandlerboxplot}%
		\pgfkeysalso{%
			/pgfplots/every boxplot,
			/pgfplots/boxplot/.cd,
			#1%
		}%
	},
	boxplot prepared/.code={%
		\def\tikz@plot@handler{\pgfplotsplothandlerboxplotprepared}%
		\pgfkeysalso{%
			/pgfplots/every boxplot,
			/pgfplots/boxplot/.cd,
			#1%
		}%
	},
	boxplot/data value/.code	=\pgfplots@set@source@for{boxplot/data}{#1}{0},%
	boxplot/data/.code			=\pgfplots@set@source@for{boxplot/data}{#1}{1},%
	boxplot/data filter/.code=,
	boxplot/data value=\pgfkeysvalueof{/data point/y},
	%
	every boxplot/.style={%
	},
	%
	% 'auto' means "if possible".
	% For boxplot prepared, this is equivalent to "disabled" (empty value).
	% For boxplot, it means "compute it".
	% Empty value means disabled.
	boxplot/median/.initial=auto,
	boxplot/lower quartile/.initial=auto,
	boxplot/upper quartile/.initial=auto,
	boxplot/lower whisker/.initial=auto,
	boxplot/upper whisker/.initial=auto,
	boxplot/average/.initial=,
	%
	boxplot/lower quartile off/.initial=0.25,
	boxplot/upper quartile off/.initial=0.75,
	%
	%
	% the size of whisker lines in axis units.
	% The default is to make it relative to 'box length'
	boxplot/whisker length/.initial=\pgfkeysvalueof{/pgfplots/boxplot/box length}*0.8,
	%
	% the size of the box in axis units. Note that this has been
	% chosen to fit the initial 'draw position':
	boxplot/box length/.initial=0.8,
	% draw direction=x|y
	boxplot/draw direction/.initial=x,	
	%
	% Activates "dynamic size" feature if not empty:
	boxplot/variable width key/.initial=auto,
	%
	% will be computed automatically if needed. If it is present, it
	% will not contribute to the axis-wide limit unless it has been
	% given axis-wide.
	boxplot/variable width key min/.initial=,
	boxplot/variable width key max/.initial=,
	%
	% this factor times 'box length' is the size for 
	% 'variable width key min'. The max value gets 'box length'.
	boxplot/variable width min target/.initial=0.2,
	%
	%
	% defines where how the "free" position is chosen. The idea is to
	% place one box at each "y" position and to number these
	% 1,2,3,4,... . This should probably simplify tick (label) generation.
	boxplot/draw position/.initial=1+\plotnumofactualtype,
	%
	% draw relative anchor=0:  
	%     |    |---|  |
	%     |    |   |  |
	%     |----|---|--|
	%
	% draw relative anchor=0.5:
	%     |    |---|  |
	%     |----|   |--|
	%     |    |---|  |
	%
	% draw relative anchor=1:  
	%     |----|---|--|
	%     |    |   |  |
	%     |    |---|  |
	boxplot/draw relative anchor/.initial=0.5,
	%
	boxplot/every whisker/.style={%
	},
	boxplot/every box/.style={%
	},
	boxplot/every median/.style={%
	},
	boxplot/every average/.style={%
		/tikz/only marks, /tikz/mark=diamond*,
	},
	boxplot/draw/lower whisker/.style={%
		/pgfplots/boxplot/draw/whisker=%
			{\pgfkeysvalueof{/pgfplots/boxplot/lower quartile}}
			{\pgfkeysvalueof{/pgfplots/boxplot/lower whisker}}
	},
	boxplot/draw/upper whisker/.style={%
		/pgfplots/boxplot/draw/whisker=%
			{\pgfkeysvalueof{/pgfplots/boxplot/upper quartile}}
			{\pgfkeysvalueof{/pgfplots/boxplot/upper whisker}}%
	},
	boxplot/draw/whisker/.code 2 args={%
		\draw[/pgfplots/boxplot/every whisker/.try]
			(boxplot cs:#1) -- (boxplot cs:#2)
			(boxplot cs:#2,{\pgfplots@boxplot@anchor@value@whisker{0}})
			--
			(boxplot cs:#2,{\pgfplots@boxplot@anchor@value@whisker{1}})
		;
	},%
	%
	boxplot/draw/box/.code={%
		\draw[/pgfplots/boxplot/every box/.try]
			(boxplot cs:\pgfkeysvalueof{/pgfplots/boxplot/lower quartile},{\pgfplots@boxplot@anchor@value{0}})
			rectangle
			(boxplot cs:\pgfkeysvalueof{/pgfplots/boxplot/upper quartile},{\pgfplots@boxplot@anchor@value{1}})
		;
	},%
	%
	boxplot/draw/average/.code={%
		\draw[/pgfplots/boxplot/every average/.try]
			\pgfextra
			\pgftransformshift{%
				\pgfplotsboxplotpointab
					{\pgfkeysvalueof{/pgfplots/boxplot/average}}
					{\pgfplots@boxplot@anchor@value{0.5}}%
			}%
			\pgfuseplotmark{\tikz@plot@mark}%
			\endpgfextra
		;
	},
	%
	boxplot/draw/median/.code={%
		\draw[/pgfplots/boxplot/every median/.try]
			(boxplot cs:\pgfkeysvalueof{/pgfplots/boxplot/median},{\pgfplots@boxplot@anchor@value{0}})
			--
			(boxplot cs:\pgfkeysvalueof{/pgfplots/boxplot/median},{\pgfplots@boxplot@anchor@value{1}})
		;
	},%
}

% A helper which implements 'draw relative anchor'. It expands to a
% math expression which is suitable as second argument for 'boxplot cs';
% i.e. it needs to be added to 'boxplot/draw position'.
% 
% More precisely, this macro is to be used in a context where lines of
% 'box length' length have to be drawn.
%
% The argument is shifted by 'draw relative anchor' and is scaled by
% 'box length'.
%
% #1: the coordinate. 0 is the means "lower part of the construct
% which is to be drawn". 1 means the "upper part of that construct"
% and 0.5 is in the middle. 
\def\pgfplots@boxplot@anchor@value#1{%
	(#1-\pgfkeysvalueof{/pgfplots/boxplot/draw relative anchor})*\pgfkeysvalueof{/pgfplots/boxplot/box length}%
}

% same as \pgfplots@boxplot@anchor@value, but for drawing constructs
% which are at most 'whisker length' long.
\def\pgfplots@boxplot@anchor@value@whisker#1{%
	(#1-\pgfkeysvalueof{/pgfplots/boxplot/draw relative anchor})*\pgfkeysvalueof{/pgfplots/boxplot/whisker length}%
}

\def\pgfplotsplothandlerboxplot{%
	\pgfplotsresetplothandler
	\def\pgf@plotstreamstart{%
		\pgfplotsset{/pgfplots/boxplot prepared}%
		\pgfplotsresetplothandler
		\tikz@plot@handler
		\pgf@plotstreamstart
	}%
	\def\pgfplotsplothandlername{boxplot}%
	\let\pgfplotsplothandlersurveypoint=\pgfplotsplothandlersurveypoint@boxplot
	\let\pgfplotsplothandlersurveystart=\pgfplotsplothandlersurveystart@boxplot
	\let\pgfplotsplothandlersurveyend=\pgfplotsplothandlersurveyend@boxplot
}


\def\pgfplotsplothandlersurveystart@boxplot{%
	\pgfplots@prepare@source@parser@for{boxplot/}{data}{\pgfplotsplothandlerboxplot@parse}%
	%
	\pgfplotscoordmath{float}{zero}%
	\let\pgfplotsplothandlerboxplot@sum=\pgfmathresult
	%
	\pgfplotscoordmath{float}{min limit}%
	\let\pgfplotsplothandlerboxplot@last=\pgfmathresult
	%
	\def\b@pgfplotsplothandlerboxplot@issorted{1}%
	%
	\pgfplotsapplistXnewempty\pgfp@boxplot@@
	\def\c@pgfplotsplothandlerboxplot@num{0}%
	\c@pgfplots@coordindex=0
}%

\def\pgfplotsplothandlersurveyend@boxplot{%
	\pgfplots@curplot@threedimfalse
	%
	\if0\b@pgfplotsplothandlerboxplot@issorted
		\pgfplotsthrow{invalid argument}{\pgfplots@loc@TMPa}{Sorry, boxplot currently expects the input to be sorted in ascending order}\pgfeov%
	\fi
	%
	\pgfplotsapplistXlet\pgfplots@boxplot@data=\pgfp@boxplot@@
	\pgfplotsapplistXnewempty\pgfp@boxplot@@
	%
	%%
	\pgfplotsplothandlersurveyend@boxplot@computestats
	\let\pgfplots@boxplot@data=\relax
	%
	%
	\pgfplotsset{%
		/pgfplots/boxplot prepared={%
			data value=\pgfplots@current@point@data,
		},%
	}%
	\pgfplotsresetplothandler
	\tikz@plot@handler
	%
	\pgfplotsplothandlersurveystart
	%
	\let\pgfplots@current@point@z=\pgfutil@empty
	% REPORT OUTLIERS:
	\pgfplotslistforeachungrouped{pgfp@boxplot@@}\as\pgfplots@current@point@data{%
		\def\pgfplots@current@point@x{0}%
		\let\pgfplots@current@point@y{0}%
%\message{Survey point (\pgfplots@current@point@x,\pgfplots@current@point@y)^^J}%
		\pgfplotsplothandlersurveypoint
	}%
	%
	\pgfplotsplothandlersurveyend
}%

%%%%

% 
% OUTPUT:
% \pgfplotsretval: the result of #1 * #2 as integer
% \pgfplotsretvalb = 1 iff #1 * #2 is an integer (without loss)
\def\pgfplots@boxplot@get@quantile@offset#1#2{%
	\pgfplotscoordmath{float}{parsenumber}{#2}%
	\pgfplotscoordmath{float}{op}{multiply}{{\pgfmathresult}{#1}}%
	\pgfplotscoordmath{float}{tofixed}{\pgfmathresult}%
	\afterassignment\pgfplots@boxplot@get@quantile@remainder
	\c@pgf@countd=\pgfmathresult\relax
	\edef\pgfplotsretval{\the\c@pgf@countd}%
}%

\def\pgfplots@boxplot@get@quantile@remainder#1\relax{%
	\ifdim #1pt>0.001pt
		\def\pgfplotsretvalb{0}%
	\else
		\def\pgfplotsretvalb{1}%
	\fi
}%

\def\pgfplotsplothandlersurveyend@boxplot@computestats{ 
	%
	%
	\edef\numcoords{\pgfplots@current@point@coordindex}%
	%
	% compute TMPa := float(\numcoords - 1)
	\pgfplotscoordmath{float}{one}%
	\let\pgfplots@loc@TMPa=\pgfmathresult
	\pgfplotscoordmath{float}{parsenumber}{\numcoords}%
	\let\pgfplots@boxplot@numcoords=\pgfmathresult
	\pgfplotscoordmath{float}{op}{subtract}{{\pgfmathresult}{\pgfplots@loc@TMPa}}%
	\let\pgfplots@boxplot@numcoords@minus@one=\pgfmathresult
	%
	\pgfplots@boxplot@get@quantile@offset{\pgfplots@boxplot@numcoords@minus@one}{\pgfkeysvalueof{/pgfplots/boxplot/lower quartile off}}%
	\let\c@pgfplotsplothandlerboxplot@lowerquartile=\pgfplotsretval
	\let\b@pgfplotsplothandlerboxplot@lowerquartile@isint=\pgfplotsretvalb
	\pgfplots@boxplot@get@quantile@offset{\pgfplots@boxplot@numcoords@minus@one}{0.5}%
	\let\c@pgfplotsplothandlerboxplot@median=\pgfplotsretval
	\let\b@pgfplotsplothandlerboxplot@median@isint=\pgfplotsretvalb
	\pgfplots@boxplot@get@quantile@offset{\pgfplots@boxplot@numcoords@minus@one}{\pgfkeysvalueof{/pgfplots/boxplot/upper quartile off}}%
	\let\c@pgfplotsplothandlerboxplot@upperquartile=\pgfplotsretval
	\let\b@pgfplotsplothandlerboxplot@upperquartile@isint=\pgfplotsretvalb
	%
	\let\c@pgfplotsplothandlerboxplot@lowerwhisker=\pgfutil@empty
	\let\c@pgfplotsplothandlerboxplot@upperwhisker=\pgfutil@empty
	%
	\let\pgfplotsplothandlerboxplot@lowerwhisker=\pgfutil@empty
	\let\pgfplotsplothandlerboxplot@lowerquartile=\pgfutil@empty
	\let\pgfplotsplothandlerboxplot@median=\pgfutil@empty
	\let\pgfplotsplothandlerboxplot@upperquartile=\pgfutil@empty
	\let\pgfplotsplothandlerboxplot@upperwhisker=\pgfutil@empty
	%
	\c@pgfplots@coordindex=0 %
	\def\pgfplots@boxplot@@next@target{lowerquartile}%
	\def\pgfplots@boxplot@next@@lowerquartile{median}%
	\def\pgfplots@boxplot@next@@median{upperquartile}%
	\def\pgfplots@boxplot@next@@upperquartile{}%
	\let\pgfplotsplothandlersurveyend@boxplot@computestats@=\pgfplotsplothandlersurveyend@boxplot@computestats@quantile
	\expandafter\pgfplotsplothandlersurveyend@boxplot@computestats@loop\pgfplots@boxplot@data\pgfplots@EOI
	%
	%
	\pgfplotscoordmath{float}{op}{divide}{{\pgfplotsplothandlerboxplot@sum}{\pgfplots@boxplot@numcoords}}%
	\let\pgfplotsplothandlerboxplot@average=\pgfmathresult
	%
	\pgfplotsplothandlersurveyend@boxplot@set{lower whisker}{\pgfplotsplothandlerboxplot@lowerwhisker}%
	\pgfplotsplothandlersurveyend@boxplot@set{lower quartile}{\pgfplotsplothandlerboxplot@lowerquartile}%
	\pgfplotsplothandlersurveyend@boxplot@set{median}{\pgfplotsplothandlerboxplot@median}%
	\pgfplotsplothandlersurveyend@boxplot@set{average}{\pgfplotsplothandlerboxplot@average}%
	\pgfplotsplothandlersurveyend@boxplot@set{upper quartile}{\pgfplotsplothandlerboxplot@upperquartile}%
	\pgfplotsplothandlersurveyend@boxplot@set{upper whisker}{\pgfplotsplothandlerboxplot@upperwhisker}%
	%
	%
	%
	\pgfplotscoordmath{float}{parsenumber}{1.5}%
	\let\pgfplots@loc@TMPa=\pgfmathresult
	\pgfplotscoordmath{float}{op}{subtract}{{\pgfplotsplothandlerboxplot@upperquartile}{\pgfplotsplothandlerboxplot@lowerquartile}}%
	\pgfplotscoordmath{float}{op}{multiply}{{\pgfmathresult}{\pgfplots@loc@TMPa}}%
	\let\pgfplots@boxplot@whisker@width=\pgfmathresult
	\pgfplotscoordmath{float}{op}{add}{{\pgfplotsplothandlerboxplot@upperquartile}{\pgfplots@boxplot@whisker@width}}%
	\let\pgfplotsplothandlerboxplot@upperwhisker@value=\pgfmathresult
	\pgfplotscoordmath{float}{op}{subtract}{{\pgfplotsplothandlerboxplot@lowerquartile}{\pgfplots@boxplot@whisker@width}}%
	\let\pgfplotsplothandlerboxplot@lowerwhisker@value=\pgfmathresult
	%
	\let\pgfplotsplothandlersurveyend@boxplot@computestats@=\pgfplotsplothandlersurveyend@boxplot@computestats@valuebased
	\expandafter\pgfplotsplothandlersurveyend@boxplot@computestats@loop\pgfplots@boxplot@data\pgfplots@EOI
	%
	\pgfplotsplothandlersurveyend@boxplot@set{lower whisker}{\pgfplotsplothandlerboxplot@lowerwhisker}%
	\pgfplotsplothandlersurveyend@boxplot@set{upper whisker}{\pgfplotsplothandlerboxplot@upperwhisker}%
	%
	\c@pgfplots@coordindex=\numcoords
}%

\def\pgfplotsplothandlersurveyend@boxplot@set#1#2{%
	\pgfkeysgetvalue{/pgfplots/boxplot/#1}\pgfplots@loc@TMPa
	\edef\pgfplots@loc@TMPa{\pgfplots@loc@TMPa}%
	\def\pgfplots@loc@TMPc{auto}%
	\ifx\pgfplots@loc@TMPa\pgfplots@loc@TMPc
		\edef\pgfmathresult{#2}%
		\ifx\pgfmathresult\pgfutil@empty
		\else
			\pgfplotscoordmath{float}{tostring}{#2}%
			\edef\pgfplots@loc@TMPb{\noexpand\pgfplotsplothandlersurveyaddoptions{/pgfplots/boxplot/#1={\pgfmathresult}}}%
			\pgfplots@loc@TMPb
		\fi
	\fi
	
}%


\def\pgfplotsplothandlersurveyend@boxplot@computestats@loop#1{%
	\def\pgfplots@loc@TMPa{#1}%
	\ifx\pgfplots@loc@TMPa\pgfplots@EOI
	\else
		%
		\let\pgfplots@current@point@data=\pgfplots@loc@TMPa
		\pgfplotsplothandlersurveyend@boxplot@computestats@
		%
		\advance\c@pgfplots@coordindex by1 %
		\expandafter\pgfplotsplothandlersurveyend@boxplot@computestats@loop
	\fi
}%

% Really computes stats.
% The data is in \pgfplots@current@point@data.
\def\pgfplotsplothandlersurveyend@boxplot@computestats@quantile{%
	%
	\c@pgf@countd=\csname c@pgfplotsplothandlerboxplot@\pgfplots@boxplot@@next@target\endcsname\relax
	\expandafter\let\expandafter\pgfplots@loc@TMPa\csname pgfplotsplothandlerboxplot@\pgfplots@boxplot@@next@target\endcsname
	%
	\message{search for \pgfplots@boxplot@@next@target=\the\c@pgf@countd: \# \pgfplots@current@point@coordindex: \pgfplots@current@point@data^^J}%
	\ifnum\c@pgf@countd=\c@pgfplots@coordindex\relax
		% Ah - we found the occurence of the current search target! 
		\expandafter\let\csname pgfplotsplothandlerboxplot@\pgfplots@boxplot@@next@target\endcsname=\pgfplots@current@point@data
		%
		\expandafter\let\expandafter\pgfplots@loc@TMPb\csname b@pgfplotsplothandlerboxplot@\pgfplots@boxplot@@next@target @isint\endcsname
		\if 1\pgfplots@loc@TMPb
\message{Found it (and is int). Advancing.^^J}%
			% ... and search for the next search target.
			\expandafter\let\expandafter\pgfplots@boxplot@@next@target\csname pgfplots@boxplot@next@@\pgfplots@boxplot@@next@target\endcsname
		\else
			% ... continue searching for the same target in order to deduplicate.
		\fi
	\else
		\ifx\pgfplots@loc@TMPa\pgfutil@empty
		\else
			% Ah! this can *only* happen if we have to compute a
			% mean between the previous and this data point.
			%
			% The current search target is 0.5 * (value + next):
			\pgfplotscoordmath{float}{op}{add}{{\pgfplots@current@point@data}{\pgfplots@loc@TMPa}}%
			\let\pgfplots@loc@TMPb=\pgfmathresult
			\pgfplotscoordmath{float}{parsenumber}{0.5}%
			\pgfplotscoordmath{float}{op}{multiply}{{\pgfmathresult}{\pgfplots@loc@TMPb}}%
			%
			\expandafter\let\csname pgfplotsplothandlerboxplot@\pgfplots@boxplot@@next@target\endcsname
				=\pgfmathresult
\message{Found it; computing mean = \pgfmathresult ^^J}%
			%
			% ... and search for the next search target.
			\expandafter\let\expandafter\pgfplots@boxplot@@next@target\csname pgfplots@boxplot@next@@\pgfplots@boxplot@@next@target\endcsname
			%
		\fi
	\fi
	%
	\ifx\pgfplots@boxplot@@next@target\pgfutil@empty
		% stop searching.
		\let\pgfplotsplothandlersurveyend@boxplot@computestats@=\relax
	\fi
}

\def\pgfplotsplothandlersurveyend@boxplot@computestats@valuebased{%
\message{searching for whiskers (lower = \pgfplotsplothandlerboxplot@lowerwhisker@value, upper =\pgfplotsplothandlerboxplot@upperwhisker@value)...^^J}%
	\pgfplotscoordmath{float}{if less than}{\pgfplots@current@point@data}{\pgfplotsplothandlerboxplot@lowerwhisker@value}{%
	}{%
		\ifx\pgfplotsplothandlerboxplot@lowerwhisker\pgfutil@empty
			\let\pgfplotsplothandlerboxplot@lowerwhisker=\pgfplots@current@point@data
		\else
			\pgfplotscoordmath{float}{min}{\pgfplotsplothandlerboxplot@lowerwhisker}{\pgfplots@current@point@data}%
			\let\pgfplotsplothandlerboxplot@lowerwhisker=\pgfmathresult
		\fi
\message{updating lower: \pgfplotsplothandlerboxplot@lowerwhisker^^J}%
	}%
	%
	\pgfplotscoordmath{float}{if less than}{\pgfplotsplothandlerboxplot@upperwhisker@value}{\pgfplots@current@point@data}{%
	}{%
		\ifx\pgfplotsplothandlerboxplot@upperwhisker\pgfutil@empty
			\let\pgfplotsplothandlerboxplot@upperwhisker=\pgfplots@current@point@data
		\else
			\pgfplotscoordmath{float}{max}{\pgfplotsplothandlerboxplot@upperwhisker}{\pgfplots@current@point@data}%
			\let\pgfplotsplothandlerboxplot@upperwhisker=\pgfmathresult
		\fi
\message{updating upper: \pgfplotsplothandlerboxplot@upperwhisker^^J}%
	}%
}


%%%

\def\pgfplotsplothandlersurveypoint@boxplot{%
	\pgfplotsplothandlerboxplot@parse
	\let\pgfplots@current@point@data=\pgfmathresult
	%
	\ifx\pgfplots@current@point@data\pgfutil@empty
	\else
		\pgfplotscoordmath{float}{if is bounded}{\pgfplots@current@point@data}{%
			%
			\pgfplotsplothandlersurveypoint@boxplot@
		}{%
		}%
	\fi
}%

\def\pgfplotsplothandlersurveypoint@boxplot@{%
	\pgfplotsutil@advancestringcounter\c@pgfplotsplothandlerboxplot@num
	%
	\if1\b@pgfplotsplothandlerboxplot@issorted
		\pgfplotscoordmath{float}{if less than}{\pgfplots@current@point@data}{\pgfplotsplothandlerboxplot@last}{%
			\def\b@pgfplotsplothandlerboxplot@issorted{0}%
		}{%
		}%
	\fi
	%
	%
	\pgfplotscoordmath{float}{op}{add}{{\pgfplots@current@point@data}{\pgfplotsplothandlerboxplot@sum}}%
	\let\pgfplotsplothandlerboxplot@sum=\pgfmathresult
	%
	% store parsed result.
	\edef\pgfmathresult{{\pgfplots@current@point@data}}%
	\expandafter\pgfplotsapplistXpushback\expandafter{\pgfmathresult}\to\pgfp@boxplot@@
	%
	\let\pgfplotsplothandlerboxplot@last=\pgfplots@current@point@data
	%
	\advance\c@pgfplots@coordindex by1
}
% =============================================================

\def\pgfplotsplothandlerboxplotprepared{%
	\ifpgfplots@stackedmode
		\pgfplotsthrow{unsupported operation}{Sorry, 'stacked plots' are currently unsupported for box plots. See the manual for 'boxplot/draw position' for how to achieve the effect (using \string\plotnumofactualtype)}\pgfeov
	\else
		\pgfplotsplothandlerboxplotprepared@
	\fi
}
\def\pgfplotsplothandlerboxplotprepared@{%
	\pgfplotsresetplothandler
	%
	\def\pgfplotsplothandlername{boxplot prepared}%
	%
	\let\pgf@plotstreamstart=\pgfplotsplothandlervisstart@boxplot@prepared
	\let\pgfplotsplothandlersurveystart=\pgfplotsplothandlersurveystart@boxplot@prepared
	\let\pgfplotsplothandlersurveypoint=\pgfplotsplothandlersurveypoint@boxplot@prepared
	\let\pgfplotsplothandlersurveyend=\pgfplotsplothandlersurveyend@boxplot@prepared
	%
	\pgfplotsplothandlerboxplotprepared@normalize@values
	%
	\pgfkeysgetvalue{/pgfplots/boxplot/draw direction}\pgfplots@loc@TMPa
	\if x\pgfkeysvalueof{/pgfplots/boxplot/draw direction}%
	\else
		\if y\pgfkeysvalueof{/pgfplots/boxplot/draw direction}%
		\else
			\pgfplotsthrow{invalid argument}{\pgfplots@loc@TMPa}{Invalid choice boxplot/draw direction=\pgfplots@loc@TMPa}\pgfeov%
			\def\pgfplots@loc@TMPa{x}%
		\fi
	\fi
	\csname pgfplotsplothandlerboxplotprepared@setxy@\pgfplots@loc@TMPa\endcsname
	%
	\def\pgfplotsboxplotpointab##1##2{%
		\begingroup
			\pgfkeys{/pgf/fpu}%
			\pgfmathparse{##1}%
			\let\pgfplotsplothandlerboxplot@@=\pgfmathresult
			\pgfmathparse{\pgfkeysvalueof{/pgfplots/boxplot/draw position} + ##2}%
			\xdef\pgfplots@glob@TMPa{{\pgfplotsplothandlerboxplot@@}{\pgfmathresult}}%
			\expandafter\pgfplotsboxplotpointab@\pgfplots@glob@TMPa{\pgfplotspointaxisxy}%
			\pgf@process{}%
		\endgroup
	}%
	\def\pgfplotsboxplotpointab@survey##1##2{%
		\edef\pgfmathresult{##1}%
		\ifx\pgfmathresult\pgfutil@empty
		\else
			\pgfmathparse{\pgfmathresult}%
		\fi
		\let\pgfplotsplothandlerboxplot@@=\pgfmathresult
		\pgfmathparse{\pgfkeysvalueof{/pgfplots/boxplot/draw position} + ##2}%
		\xdef\pgfplots@glob@TMPa{{\pgfplotsplothandlerboxplot@@}{\pgfmathresult}}%
		\let\pgfplotsplothandlerboxplot@modified@draw@position=\pgfmathresult%
		\expandafter\pgfplotsboxplotpointab@\pgfplots@glob@TMPa{\pgfplotsboxplotpointab@@define@current@xy}%
	}%
}%

\def\pgfplotsplothandlerboxplotprepared@normalize@values{%
	\def\pgfplots@loc@TMPa{auto}%
	\pgfplotsforeachentryinCSV{\value}{%
		lower whisker,%
		lower quartile,%
		median,%
		average,%
		upper quartile,%
		upper whisker,%
		variable width key%
	}{%
		\pgfkeysgetvalue{/pgfplots/boxplot/\value}\pgfplots@loc@TMPb
		\edef\pgfplots@loc@TMPb{\pgfplots@loc@TMPb}%
		\ifx\pgfplots@loc@TMPb\pgfplots@loc@TMPa
			\pgfkeyslet{/pgfplots/boxplot/\value}\pgfutil@empty
		\fi
	}%
}%

\def\pgfplotsboxplotpointab@@define@current@xy#1#2{%
	\edef\pgfplots@current@point@x{#1}%
	\edef\pgfplots@current@point@y{#2}%
}%

\def\pgfplotsplothandlerboxplotprepared@setxy@x{%
	\def\pgfplotsboxplotpointab@##1##2##3{%
		##3{##1}{##2}%
	}%
}%
\def\pgfplotsplothandlerboxplotprepared@setxy@y{%
	\def\pgfplotsboxplotpointab@##1##2##3{%
		##3{##2}{##1}%
	}%
}%

\def\pgfplotsplothandlersurveypoint@boxplot@collect@limits{%
	\pgfplotsaxisparsecoordinate
	\pgfplotsaxispreparecoordinate
	\ifpgfplotsaxisparsecoordinateok
		\pgfplotsaxisupdatelimitsforcoordinate\pgfplots@current@point@x\pgfplots@current@point@y\pgfplots@current@point@z
	\fi
	%
	% do NOT store the processed coordinate! the coordinate stream
	% is ONLY for outliers.
	%
	% ... but update this stuff to avoid a "plot without coordinates"
	% case
	\pgfplotscoordstream@firstlast@update
}

\def\pgfplotsplothandlersurveystart@boxplot@prepared{%
	\pgfplots@prepare@source@parser@for{boxplot/}{data}{\pgfplotsplothandlerboxplot@parse}%
	%
	\pgfplotsplothandlersurveystart@default
}

\def\pgfplotsplothandlersurveypoint@boxplot@prepared{%
	% seems the "parse" routine is stupid ... the /data point/ stuff
	% is redefined although it should not. Strange...
	\pgfkeyslet{/data point/x}\pgfplots@current@point@x
	\pgfkeyslet{/data point/y}\pgfplots@current@point@y
	\pgfkeyslet{/data point/z}\pgfplots@current@point@z
	\pgfplotsplothandlerboxplot@parse
	%
	\pgfplotsboxplotpointab@survey{\pgfmathresult}{0}%
	%
	\pgfplotsplothandlersurveypoint@default
}

\def\pgfplotsplothandlersurveyend@boxplot@prepared{%
	\let\pgfplots@invoke@filter@xyz@old=\pgfplots@invoke@filter@xyz
	\let\pgfplots@invoke@filter@xyz=\relax
	\let\pgfplots@invoke@filter@old=\pgfplots@invoke@filter
	\def\pgfplots@invoke@filter##1##2{}%
	\let\pgfplots@invoke@prefilter@old=\pgfplots@invoke@prefilter
	\let\pgfplots@invoke@prefilter=\relax
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/lower whisker}}
		{\pgfplots@boxplot@anchor@value@whisker{0}}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/lower whisker}}
		{\pgfplots@boxplot@anchor@value@whisker{1}}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/lower quartile}}%
		{\pgfplots@boxplot@anchor@value{0}}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/lower quartile}}%
		{\pgfplots@boxplot@anchor@value{1}}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/median}}
		{\pgfplots@boxplot@anchor@value0}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/median}}
		{\pgfplots@boxplot@anchor@value1}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/average}}
		{\pgfplots@boxplot@anchor@value0}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/average}}
		{\pgfplots@boxplot@anchor@value1}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/upper quartile}}%
		{\pgfplots@boxplot@anchor@value0}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/upper quartile}}%
		{\pgfplots@boxplot@anchor@value1}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	%
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/upper whisker}}%
		{\pgfplots@boxplot@anchor@value@whisker1}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	\pgfplotsboxplotpointab@survey
		{\pgfkeysvalueof{/pgfplots/boxplot/upper whisker}}%
		{\pgfplots@boxplot@anchor@value@whisker0}%
	\pgfplotsplothandlersurveypoint@boxplot@collect@limits
	%
	\let\pgfplots@invoke@prefilter=\pgfplots@invoke@prefilter@old
	\let\pgfplots@invoke@filter=\pgfplots@invoke@filter@old
	\let\pgfplots@invoke@filter@xyz=\pgfplots@invoke@filter@xyz@old
	%
	\pgfplotsplothandlerboxplotsurvey@variable@width%
	%
	\pgfplotsplothandlersurveyend@default
}%

\def\pgfplotsplothandlerboxplotsurvey@variable@width{%
	\ifnum\plotnumofactualtype=0 %
		% Ah - the first boxplot in this axis. Init the global
		% counter:
		\pgfplotscoordmath{default}{max limit}%
		\global\let\g@pgfplotsplothandlerboxplot@widthkey@min=\pgfmathresult
		\pgfplotscoordmath{default}{min limit}%
		\global\let\g@pgfplotsplothandlerboxplot@widthkey@max=\pgfmathresult
	\fi
	%
	%
	\pgfkeysgetvalue{/pgfplots/boxplot/variable width key}\pgfmathresult
	\edef\pgfmathresult{\pgfmathresult}%
	\ifx\pgfmathresult\pgfutil@empty
	\else
		\pgfmathparse{\pgfmathresult}%
		\let\pgfplots@widthkey@=\pgfmathresult
		%
		\pgfkeysgetvalue{/pgfplots/boxplot/variable width key min}\pgfmathresult
		\edef\pgfplotsplothandlerboxplot@widthkey@min{\pgfmathresult}%
		%
		\pgfkeysgetvalue{/pgfplots/boxplot/variable width key max}\pgfmathresult
		\edef\pgfplotsplothandlerboxplot@widthkey@max{\pgfmathresult}%
		%
		%
		\ifx\pgfplotsplothandlerboxplot@widthkey@min\pgfutil@empty
			\let\pgfplotsplothandlerboxplot@widthkey@min=\g@pgfplotsplothandlerboxplot@widthkey@min
			\def\pgfplotsplothandlerboxplot@widthkey@min@autocompute{1}%
		\else
			\def\pgfplotsplothandlerboxplot@widthkey@min@autocompute{0}%
		\fi
		\ifx\pgfplotsplothandlerboxplot@widthkey@max\pgfutil@empty
			\let\pgfplotsplothandlerboxplot@widthkey@max=\g@pgfplotsplothandlerboxplot@widthkey@max
			\def\pgfplotsplothandlerboxplot@widthkey@max@autocompute{1}%
		\else
			\def\pgfplotsplothandlerboxplot@widthkey@max@autocompute{0}%
		\fi
		%
		\if1\pgfplotsplothandlerboxplot@widthkey@max@autocompute
			\pgfmathparse{max(\pgfplotsplothandlerboxplot@widthkey@max,\pgfplots@widthkey@)}%
			\global\let\g@pgfplotsplothandlerboxplot@widthkey@max=\pgfmathresult
			\let\pgfplotsplothandlerboxplot@widthkey@max=\pgfmathresult
			%
			\pgfmathparse{min(\pgfplotsplothandlerboxplot@widthkey@min,\pgfplots@widthkey@)}%
			\global\let\g@pgfplotsplothandlerboxplot@widthkey@min=\pgfmathresult
			\let\pgfplotsplothandlerboxplot@widthkey@min=\pgfmathresult
		\fi
	\fi
	%
%\message{variable width key=\pgfplots@widthkey@. interval = \pgfplotsplothandlerboxplot@widthkey@min:\pgfplotsplothandlerboxplot@widthkey@max^^J}%
}%

\def\pgfplotsplothandlerboxplotvisualization@variable@width{%
	\pgfkeysgetvalue{/pgfplots/boxplot/variable width key}\pgfmathresult
	\edef\pgfmathresult{\pgfmathresult}%
	\ifx\pgfmathresult\pgfutil@empty
	\else
		\let\pgfplots@widthkey@=\pgfmathresult
		%
		\pgfkeysgetvalue{/pgfplots/boxplot/variable width key min}\pgfmathresult
		\edef\pgfplotsplothandlerboxplot@widthkey@min{\pgfmathresult}%
		%
		\pgfkeysgetvalue{/pgfplots/boxplot/variable width key max}\pgfmathresult
		\edef\pgfplotsplothandlerboxplot@widthkey@max{\pgfmathresult}%
		%
		%
		\ifx\pgfplotsplothandlerboxplot@widthkey@min\pgfutil@empty
			\let\pgfplotsplothandlerboxplot@widthkey@min=\g@pgfplotsplothandlerboxplot@widthkey@min
		\fi
		\ifx\pgfplotsplothandlerboxplot@widthkey@max\pgfutil@empty
			\let\pgfplotsplothandlerboxplot@widthkey@max=\g@pgfplotsplothandlerboxplot@widthkey@max
		\fi
		%
		\pgfkeysgetvalue{/pgfplots/boxplot/variable width min target}\pgfplots@widthkey@mintrg
		\pgfkeysgetvalue{/pgfplots/boxplot/box length}\pgfplots@loc@TMPa
%\message{variable width key=\pgfplots@widthkey@. interval = \pgfplotsplothandlerboxplot@widthkey@min:\pgfplotsplothandlerboxplot@widthkey@max. Target = [\pgfplots@widthkey@mintrg:1]^^J}%
		\begingroup
		\pgfkeys{/pgf/fpu}%
		\pgfmathparse{
			(\pgfplots@widthkey@mintrg + 
			max(0,min(1,(\pgfplots@widthkey@ - \pgfplotsplothandlerboxplot@widthkey@min) / 
		   	(\pgfplotsplothandlerboxplot@widthkey@max - \pgfplotsplothandlerboxplot@widthkey@min))) 
			  * (1-\pgfplots@widthkey@mintrg)) * \pgfplots@loc@TMPa}%
		\pgfmathfloattofixed\pgfmathresult
		\pgfmath@smuggleone\pgfmathresult
	 	\endgroup
		\pgfkeyslet{/pgfplots/boxplot/box length}\pgfmathresult
	\fi
}%

\def\pgfplotsplothandlervisstart@boxplot@prepared{%
	%
	\pgfplotsplothandlerboxplotvisualization@variable@width
	%
	\global\let\pgf@plotstreampoint=\pgfutil@gobble
	\global\let\pgf@plotstreamspecial=\pgfutil@gobble%
	\global\let\pgf@plotstreamend=\relax
	%
	\pgfplotsplothandlervisstart@boxplot@prepared@draw
}%

\def\pgfplotsplothandlervisstart@boxplot@prepared@draw{%
	\def\b@pgfplots@boxplot@hasbox{1}%
	\edef\pgfplots@loc@TMPa{\pgfkeysvalueof{/pgfplots/boxplot/lower quartile}}%
	\ifx\pgfplots@loc@TMPa\pgfutil@empty
		\def\b@pgfplots@boxplot@hasbox{0}%
	\fi
	\edef\pgfplots@loc@TMPa{\pgfkeysvalueof{/pgfplots/boxplot/upper quartile}}%
	\ifx\pgfplots@loc@TMPa\pgfutil@empty
		\def\b@pgfplots@boxplot@hasbox{0}%
	\fi
	%
	\if0\b@pgfplots@boxplot@hasbox
		% hm. we have no box. Very strange boxplot, I'd say.
		%
		% But anyway: if someone has whiskers without box,
		% short-circuit the whiskers:
		\edef\pgfplots@loc@TMPa{\pgfkeysvalueof{/pgfplots/boxplot/lower whisker}}%
		\edef\pgfplots@loc@TMPb{\pgfkeysvalueof{/pgfplots/boxplot/upper whisker}}%
		\pgfkeyslet{/pgfplots/boxplot/lower quartile}\pgfplots@loc@TMPb
		\pgfkeyslet{/pgfplots/boxplot/upper quartile}\pgfplots@loc@TMPa
	\fi
	%
	%
	\edef\pgfplots@loc@TMPa{\pgfkeysvalueof{/pgfplots/boxplot/lower whisker}}%
	\ifx\pgfplots@loc@TMPa\pgfutil@empty
	\else
		\pgfkeysvalueof{/pgfplots/boxplot/draw/lower whisker/.@cmd}\pgfeov
	\fi
	%
	\edef\pgfplots@loc@TMPa{\pgfkeysvalueof{/pgfplots/boxplot/upper whisker}}%
	\ifx\pgfplots@loc@TMPa\pgfutil@empty
	\else
		\pgfkeysvalueof{/pgfplots/boxplot/draw/upper whisker/.@cmd}\pgfeov
	\fi
	%
	\if1\b@pgfplots@boxplot@hasbox
		\pgfkeysvalueof{/pgfplots/boxplot/draw/box/.@cmd}\pgfeov
	\fi
	%
	\edef\pgfplots@loc@TMPa{\pgfkeysvalueof{/pgfplots/boxplot/median}}%
	\ifx\pgfplots@loc@TMPa\pgfutil@empty
	\else
		\pgfkeysvalueof{/pgfplots/boxplot/draw/median/.@cmd}\pgfeov
	\fi
	%
	\edef\pgfplots@loc@TMPa{\pgfkeysvalueof{/pgfplots/boxplot/average}}%
	\ifx\pgfplots@loc@TMPa\pgfutil@empty
	\else
		\pgfkeysvalueof{/pgfplots/boxplot/draw/average/.@cmd}\pgfeov
	\fi
}%

\tikzdeclarecoordinatesystem{boxplot}{%
	\edef\pgfplots@loc@TMPa{#1}%
	\expandafter\pgfutil@in@\expandafter,\expandafter{\pgfplots@loc@TMPa}%
	\ifpgfutil@in@
		\def\pgfplots@loc@TMPb##1,##2\pgfplots@EOI{%
			\def\pgfplots@boxplotcs@a{##1}%
			\def\pgfplots@boxplotcs@b{##2}%
		}%
		\expandafter\pgfplots@loc@TMPb\pgfplots@loc@TMPa\pgfplots@EOI
	\else
		\let\pgfplots@boxplotcs@a=\pgfplots@loc@TMPa%
		\def\pgfplots@boxplotcs@b{0}%
	\fi
	\pgfplotsboxplotpointab{\pgfplots@boxplotcs@a}{\pgfplots@boxplotcs@b}%
}%
\endinput
