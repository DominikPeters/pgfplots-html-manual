%--------------------------------------------
%
% Package pgfplots, library for ternary plots (triangular axes).
%
% Copyright 2010 by Christian Feuers√§nger.
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%
% 
% This is a library to draw ternary diagrams.
%
% How to read a ternary diagram:
%  http://www.sv.vt.edu/classes/MSE2094_NoteBook/96ClassProj/experimental/ternary2.html
% A ternary diagram visualizes percentages of three components in a
% triangle.
%
% Sometimes there is also contour data drawn on top of the ternary
% diagram, i.e. data (x,y,z, T(x,y,z) ), but I can't do that yet.
%
%http://staff.aist.go.jp/a.noda/programs/ternary/ternary-en.html
%
%
% FIXME : it won't work this way.
%
% I misunderstood the nonlinear transformation and its implications.
%
% how do you draw the x axis!? It is
%   (1,0,0) -- (0,0,1)
% and *NOT*
% 	(1,0,0) -- (1,0,1) !
% The oriented surf framework always keeps one coordinate fixed;
% that's not useful here.
%
% Furthermore, the condition x+y+z = 1  is never met by any of the
% tick line or grid line paths. It won't work.
%
% Can I change the meaning of "oriented surf"? Otherwise, I'd need to
% re-implement everything. Not very extensible
%--------------------------------------------

\pgfplotsdefineaxistype{triangle}{%
	\pgfplots@ternary@activate
}%
\pgfplotsdefineaxistype{ternary}{%
	\pgfplots@ternary@activate
}%

\pgfplotsset{
	/pgfplots/every triangle axis/.style={
		/pgfplots/tick align=outside, % FIXME : that's wrong. Seems as if something points into the wrong dir.
	},
	/pgfplots/every ternary axis/.style={
		/pgfplots/every triangle axis,
	},
}

\def\pgfplots@ternary@activate{%
	\let\pgfplotsqpointxyz=\pgfplots@ternary@qpointxyz
	\let\pgfplots@draw@axis=\pgfplots@ternary@draw@axis
	\def\pgfplots@drawaxis@outerlines@separate@onorientedsurf##1##2{}%
	\def\pgfplots@drawaxis@innerlines@onorientedsurf##1##2##3{}%
	\let\pgfplots@draw@axis@post=\pgfplots@ternary@draw@axis@post
	\let\pgfplots@initsizes=\pgfplots@ternary@initsizes
	\let\pgfplotspoint@initialisation@axes=\pgfplots@ternary@point@initialisation@axes
	\let\pgfplots@initsizes@setunitvector=\pgfplots@ternary@initsizes@setunitvector
	\let\pgfplotspointouternormalvectorofaxis@=\pgfplotspointouternormalvectorofaxis@ternary
	\let\pgfplots@prepare@ZERO@coordinates=\pgfplots@prepare@ZERO@coordinates@ternary
	\def\pgfplots@drawtickgridlines@INSTALLCLIP@onorientedsurf##1{}%
	\pgfkeys{/pgfplots/oriented surf installed/.add={}{%
		\let\pgfplotspointonorientedsurfaceab@ternary@orig=\pgfplotspointonorientedsurfaceab
		\let\pgfplotspointonorientedsurfaceab=\pgfplotspointonorientedsurfaceab@ternary
	}}%
	\let\pgfplotspointonorientedsurfaceabwithbshift=\pgfplotspointonorientedsurfaceabwithbshift@ternary
	\pgfkeyssetvalue{/pgfplots/view/az}{}%
	\pgfkeyssetvalue{/pgfplots/view/el}{}%
	\let\pgfplots@set@options@sanitize=\relax
	\let\pgfplots@set@options@sanitizemode=\relax
	\pgfplotsset{
		enlargelimits=false,
		clip=false,
		disabledatascaling,
		xmin=0,xmax=1,
		ymin=0,ymax=1,
		zmin=0,zmax=1,
	}%
	\def\pgfplots@xticklabel@pos{}%
	\def\pgfplots@yticklabel@pos{}%
	\def\pgfplots@zticklabel@pos{}%
	%\def\pgfplots@xaxislinesnum{1}%
	%\def\pgfplots@yaxislinesnum{3}%
	%\def\pgfplots@zaxislinesnum{3}%
	\def\pgfplotsifaxissurfaceisforeground##1##2##3{##2}%
	\def\pgfplots@init@ticklabelaxisspecfor##1##2{}%
	\def\pgfplots@xticklabelaxisspec{v00}%
	\def\pgfplots@yticklabelaxisspec{0v0}%
	\def\pgfplots@zticklabelaxisspec{00v}%
	\def\pgfplots@ifaxisline@B@onorientedsurf@should@be@drawn@##1##2##3{%
		\pgfplotspointonorientedsurfaceabtolinespec v##1%
		\edef\pgfplots@loc@TMPe{\csname pgfplots@\pgfplotspointonorientedsurfaceA ticklabelaxisspec\endcsname}%
		\ifx\pgfplots@loc@TMPe\pgfplotsretval
\message{pgfplots@ifaxisline@B@onorientedsurf@should@be@drawn@{##1}--->  TRUE.}%
			##2%
		\else
\message{pgfplots@ifaxisline@B@onorientedsurf@should@be@drawn@{##1}--->  FALSE.}%
			##3%
		\fi
	}%
	\def\pgfplots@ifgridlines@onorientedsurf@should@be@drawn##1##2{%
		##1% FIXME
	}%
	\def\pgfplotspointonorientedsurfaceabmatchaxisline##1##2{%
		\pgfplotspointonorientedsurfaceabtolinespec v0% FIXME that's just a bad guess!
		\edef\pgfplots@loc@TMPe{##1}%
		\ifx\pgfplots@loc@TMPe\pgfplotsretval
			\def##2{0}%
		\else
			\def##2{}%
		\fi
	}%
	\let\pgfplots@ifaxisline@B@onorientedsurf@should@be@drawn=\pgfplots@ifaxisline@B@onorientedsurf@should@be@drawn@%
}%

\def\pgfplotspointonorientedsurfaceab@ternary#1#2{%
	\let\pgfplotspointonorientedsurfaceab@ternary@fixedx=\pgfplotspointonorientedsurfaceabsetupfor@fixedx
	\let\pgfplotspointonorientedsurfaceab@ternary@fixedy=\pgfplotspointonorientedsurfaceabsetupfor@fixedy
	\let\pgfplotspointonorientedsurfaceab@ternary@fixedz=\pgfplotspointonorientedsurfaceabsetupfor@fixedz
	%
\message{\string\pgfplotspointonorientedsurfaceab{#1}{#2} -----> }%
	\ifpgfplots@ternary@next@is@unitinterval
		\edef\pgfplotspointonorientedsurfaceab@ternary@A{#1}%
		\edef\pgfplotspointonorientedsurfaceab@ternary@B{#2}%
	\else
		\pgfmath@basic@subtract@{#1}{\csname pgfplots@\pgfplotspointonorientedsurfaceA min\endcsname}%
		\pgfmath@basic@multiply@{\pgfmathresult}{\csname pgfplots@ternary@pre@map@scale@\pgfplotspointonorientedsurfaceA\endcsname}%
		\let\pgfplotspointonorientedsurfaceab@ternary@A=\pgfmathresult
		%
		\pgfmath@basic@subtract@{#2}{\csname pgfplots@\pgfplotspointonorientedsurfaceB min\endcsname}%
		\pgfmath@basic@multiply@{\pgfmathresult}{\csname pgfplots@ternary@pre@map@scale@\pgfplotspointonorientedsurfaceB\endcsname}%
		\let\pgfplotspointonorientedsurfaceab@ternary@B=\pgfmathresult
	\fi
	\if0\pgfplotspointonorientedsurfacespecsymbol
	\else
		\pgfplots@error{Internal processing error: only \string\pgfplotspointonorientedsurfaceab\space for ternary axes works only for oriented surfs fixed to LOWER or UPPER axis limits.}%
	\fi
\message{A=\pgfplotspointonorientedsurfaceab@ternary@A; B=\pgfplotspointonorientedsurfaceab@ternary@B -----> }%
	\ifdim\pgfplotspointonorientedsurfaceab@ternary@B pt=0pt
		\pgfmath@basic@subtract@{1}{\pgfplotspointonorientedsurfaceab@ternary@A}%
		\let\pgfplotspointonorientedsurfaceab@ternary@B=\pgfmathresult
		\expandafter\def\csname pgfplotspointonorientedsurfaceabsetupfor@fixed\pgfplotspointonorientedsurfaceN\endcsname{0}%
	\else
		%\let\pgfplots@loc@TMPa=\pgfplotspointonorientedsurfaceab@ternary@A
		%\pgfmath@basic@subtract@{1}{\pgfplotspointonorientedsurfaceab@ternary@A}%
		%\let\pgfplotspointonorientedsurfaceab@ternary@A=\pgfmathresult
		%\let\pgfplotspointonorientedsurfaceab@ternary@B=\pgfplots@loc@TMPa
		\pgfmath@basic@subtract@{1}{\pgfplotspointonorientedsurfaceab@ternary@A}%
		\def\pgfplotspointonorientedsurfaceab@ternary@B{0}%
		\expandafter\let\csname pgfplotspointonorientedsurfaceabsetupfor@fixed\pgfplotspointonorientedsurfaceN\endcsname=\pgfmathresult%
	\fi
	%
	\global\pgfplots@ternary@next@is@unitintervaltrue
\message{\string\pgfplotspointonorientedsurfaceab@orig{\pgfplotspointonorientedsurfaceab@ternary@A}{\pgfplotspointonorientedsurfaceab@ternary@B}[fixedsymbol=\pgfplotspointonorientedsurfacespecsymbol; a=\pgfplotspointonorientedsurfaceA,b=\pgfplotspointonorientedsurfaceB.]}%
	\pgfplotspointonorientedsurfaceab@ternary@orig
		{\pgfplotspointonorientedsurfaceab@ternary@A}%
		{\pgfplotspointonorientedsurfaceab@ternary@B}%
	%
	\let\pgfplotspointonorientedsurfaceabsetupfor@fixedx=\pgfplotspointonorientedsurfaceab@ternary@fixedx
	\let\pgfplotspointonorientedsurfaceabsetupfor@fixedy=\pgfplotspointonorientedsurfaceab@ternary@fixedy
	\let\pgfplotspointonorientedsurfaceabsetupfor@fixedz=\pgfplotspointonorientedsurfaceab@ternary@fixedz
}%

\def\pgfplotspointonorientedsurfaceabwithbshift@ternary#1#2#3{%
\message{Ich bin in \string\pgfplotspointonorientedsurfaceabwithbshift@ternary{#1}{#2}{#3}...}%
	\pgfplotspointonorientedsurfaceab@ternary{#1}{#2}%
	\edef\pgfplots@loc@TMPe{\pgf@x=\the\pgf@x\space\pgf@y=\the\pgf@y\space}%
	\pgfpointadd
		{\pgfplots@loc@TMPe}%
		{%
			\begingroup
			\pgf@xa=#3\relax
			\edef\pgfplots@loc@TMPa{\pgf@sys@tonumber\pgf@xa}%
			\pgfmath@basic@multiply@{\csname pgfplots@\pgfplotspointonorientedsurfaceB @inverseveclength\endcsname}{\pgfplots@loc@TMPa}%
			\pgfmath@smuggleone\pgfmathresult
			\endgroup
			\let\pgfplots@loc@TMPa=\pgfmathresult
			\pgfqpointscale{\pgfplots@loc@TMPa}{\csname pgfplotspointunit\pgfplotspointonorientedsurfaceB\endcsname}%
		}%
}

\let\pgfplots@ternary@initsizes@orig=\pgfplots@initsizes
\def\pgfplots@ternary@initsizes{%
	\ifpgfplots@threedim
	\else
	 	\pgfplots@error{Sorry, 'axis type=triangle' needs a three dimensional axes. Make sure you supplied three dimensional coordinates (using \string\addplot3, for example). This error is critical; I can't recover}%
	\fi
\message{ternary with limits x=[\pgfplots@xmin:\pgfplots@xmax], y=[\pgfplots@ymin:\pgfplots@ymax];  z=[\pgfplots@zmin:\pgfplots@zmax].}%
	\pgfplots@ternary@init@pre@map x
	\pgfplots@ternary@init@pre@map y
	\pgfplots@ternary@init@pre@map z
	\pgfplots@ternary@initsizes@orig
}%

\def\pgfplots@ternary@init@pre@map#1{%
	\pgfmath@basic@subtract@
		{\csname pgfplots@#1max\endcsname}
		{\csname pgfplots@#1min\endcsname}%
	\pgfmath@basic@reciprocal@\pgfmathresult
	\expandafter\let\csname pgfplots@ternary@pre@map@scale@#1\endcsname=\pgfmathresult
}

\def\pgfplots@ternary@initsizes@setunitvector#1#2#3#4{%
	\def#4{0}% whether we have (#1,0) or (0,#1)
	\ifcase#2%
		\pgfsetxvec{%
			\pgfpointdiff
				{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplots@ternary@qpointxyz001}
				{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplots@ternary@qpointxyz100}%
		}%
	\or
		\pgfsetyvec{%
			\pgfpointdiff
				{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplots@ternary@qpointxyz100}
				{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplots@ternary@qpointxyz010}%
		}%
	\or
		\pgfsetzvec{%
			\pgfpointdiff
				{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplots@ternary@qpointxyz010}
				{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplots@ternary@qpointxyz001}%
		}%
	\fi
	\pgfmathveclen{\csname pgf@#1x\endcsname}{\csname pgf@#1y\endcsname}%
	% The numbers 1/||e_x|| and 1/||e_y|| are used by the tick
	% placement code to convert between logical and physical
	% coordinates.
	\expandafter\let\csname pgfplots@#1@veclength\endcsname=\pgfmathresult
	\pgfplotsmath@ifzero{\pgfmathresult}{%
		\expandafter\def\csname pgfplots@#1@inverseveclength\endcsname{infty}%
	}{%
		\expandafter\pgfmathreciprocal@\expandafter{\pgfmathresult}%
		\expandafter\let\csname pgfplots@#1@inverseveclength\endcsname=\pgfmathresult
	}%
%\message{-> got unitvector(#1) = (\the\csname pgf@#1x\endcsname, \the\csname pgf@#1y\endcsname).}%
}%

\newif\ifpgfplots@ternary@next@is@unitinterval

% gx(x,y,z) = 0.5 * (x + 2*z)/(x+y+z)
% gy(x,y,z) = (sqrt(3) / 2) * x / (x+y+z)
\def\pgfplots@ternary@qpointxyz#1#2#3{%
	\pgf@process{%
		\dimen1=#1pt
		\dimen2=#2pt
		\dimen3=#3pt
		\ifpgfplots@ternary@next@is@unitinterval
		\else
			\advance\dimen1 by-\pgfplots@xmin pt
			\dimen1=\pgfplots@ternary@pre@map@scale@x\dimen1
			%
			\advance\dimen2 by-\pgfplots@ymin pt
			\dimen2=\pgfplots@ternary@pre@map@scale@y\dimen2
			%
			\advance\dimen3 by-\pgfplots@zmin pt
			\dimen3=\pgfplots@ternary@pre@map@scale@z\dimen3
		\fi
		\global\pgfplots@ternary@next@is@unitintervalfalse
		%
		\edef\pgfplots@temp{{\the\dimen1}{\the\dimen2}{\the\dimen3}}%
		\expandafter\pgfplots@ternary@qpointxyz@\pgfplots@temp
	}%
}%
\def\pgfplots@ternary@qpointxyz@#1#2#3{%
	\dimen0=#1
	\advance\dimen0 by#2
	\advance\dimen0 by#3
	\edef\pgfplots@ternary@sum{\pgf@sys@tonumber{\dimen0}}%
	\pgfmath@basic@divide@
		{200}% for testing and debugging.
		{\pgfplots@ternary@sum}%
	\let\pgfplots@ternary@scale=\pgfmathresult
	%
	\dimen1=#1
	\dimen3=#3
	\dimen3=2\dimen3
	\advance\dimen1 by \dimen3
	\dimen1=0.5\dimen1
	\pgf@x=\pgfplots@ternary@scale\dimen1
	%
	\dimen1=#1
	\dimen1=0.866025403784\dimen1 % *= sqrt(3)/2 
	\pgf@y=\pgfplots@ternary@scale\dimen1
	%
}%

% POSTCONDITION: the macros
% 	\pgfplotspointminminmin
% 	\pgfplotspoint[xyz]axis
% 	\pgfplotspoint[xyz]axislength
%   are defined (globally).
\def\pgfplots@ternary@point@initialisation@axes{%
	\begingroup
	\xdef\pgfplotspointminminmin{\noexpand\pgfpointorigin}%
	%
	%--------------------------------------------------
	% \pgfpointdiff
	% 	{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplotsqpointxyz001}%
	% 	{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplotsqpointxyz100}%
	%-------------------------------------------------- 
	\xdef\pgfplotspointxaxis{\noexpand\pgf@x=\the\pgf@xx\space\noexpand\pgf@y=\the\pgf@xy\space}%
	\xdef\pgfplotspointxaxislength{\pgfplots@x@veclength pt}%
	%
	\xdef\pgfplotspointyaxis{\noexpand\pgf@x=\the\pgf@yx\space\noexpand\pgf@y=\the\pgf@yy\space}%
	\xdef\pgfplotspointyaxislength{\pgfplots@y@veclength pt}%
	%
	\xdef\pgfplotspointzaxis{\noexpand\pgf@x=\the\pgf@zx\space\noexpand\pgf@y=\the\pgf@zy\space}%
	\xdef\pgfplotspointzaxislength{\pgfplots@z@veclength pt}%
	\endgroup
	%
}
\def\pgfplots@prepare@ZERO@coordinates@ternary{%
	\ifpgfplots@xislinear
		\ifpgfplots@apply@datatrafo@x
			\pgfplotscoordmath{x}{parsenumber}{0}%
			\pgfplotscoordmath{x}{datascaletrafo}{\pgfmathresult}%
			\global\let\pgfplots@logical@ZERO@x=\pgfmathresult
		\else
			\gdef\pgfplots@logical@ZERO@x{0}%
		\fi
		\pgfplotsmathmax{\pgfplots@logical@ZERO@x}{\pgfplots@xmin}%
		\global\let\pgfplots@logical@ZERO@x=\pgfmathresult
		\pgfplotsmathmin{\pgfplots@logical@ZERO@x}{\pgfplots@xmax}%
		\global\let\pgfplots@logical@ZERO@x=\pgfmathresult
	\else
		\global\let\pgfplots@logical@ZERO@x=\pgfplots@xmin%
	\fi
	%
	\ifpgfplots@yislinear
		\ifpgfplots@apply@datatrafo@y
			\pgfplotscoordmath{y}{parsenumber}{0}%
			\pgfplotscoordmath{y}{datascaletrafo}{\pgfmathresult}%
			\global\let\pgfplots@logical@ZERO@y=\pgfmathresult
		\else
			\gdef\pgfplots@logical@ZERO@y{0}%
		\fi
		\pgfplotsmathmax{\pgfplots@logical@ZERO@y}{\pgfplots@ymin}%
		\global\let\pgfplots@logical@ZERO@y=\pgfmathresult
		\pgfplotsmathmin{\pgfplots@logical@ZERO@y}{\pgfplots@ymax}%
		\global\let\pgfplots@logical@ZERO@y=\pgfmathresult
	\else
		\global\let\pgfplots@logical@ZERO@y=\pgfplots@ymin%
	\fi
	%
	\ifpgfplots@threedim
		\ifpgfplots@zislinear
			\ifpgfplots@apply@datatrafo@z
				\pgfplotscoordmath{z}{parsenumber}{0}%
				\pgfplotscoordmath{z}{datascaletrafo}{\pgfmathresult}%
				\global\let\pgfplots@logical@ZERO@z=\pgfmathresult
			\else
				\gdef\pgfplots@logical@ZERO@z{0}%
			\fi
			\pgfplotsmathmax{\pgfplots@logical@ZERO@z}{\pgfplots@zmin}%
			\global\let\pgfplots@logical@ZERO@z=\pgfmathresult
			\pgfplotsmathmin{\pgfplots@logical@ZERO@z}{\pgfplots@zmax}%
			\global\let\pgfplots@logical@ZERO@z=\pgfmathresult
		\else
			\global\let\pgfplots@logical@ZERO@z=\pgfplots@zmin%
		\fi
	\fi
	%
	%
	\global\pgfplots@ternary@next@is@unitintervaltrue
	\pgfplotsqpointxyz100%
	\xdef\pgfplots@ZERO@x{\the\pgf@x}%
	\xdef\pgfplots@ZERO@y{\the\pgf@y}%
	\xdef\pgfplotspointaxisorigin{\noexpand\pgf@x=\pgfplots@ZERO@x\space\noexpand\pgf@y=\pgfplots@ZERO@y\space}%
}%


\def\pgfplots@ternary@draw@axis{%
	%
	% this should become the line for varying y:
	\pgfplotspointonorientedsurfaceabsetupforsetz{\pgfplots@zmin}{0}%
	\pgfplots@draw@axis@insurface yxz
	%\pgfplots@draw@axis@insurface yzz % FIXME : should be yzz here!
	%
	% this should become the line for varying z:
	\pgfplotspointonorientedsurfaceabsetupforsetx{\pgfplots@xmin}{0}%
	\pgfplots@draw@axis@insurface zyx
	%
	%
	% this should become the line for varying x:
	\pgfplotspointonorientedsurfaceabsetupforsety{\pgfplots@ymin}{0}%
	\pgfplots@draw@axis@insurface xzy
	%
	\pgfplots@ternary@draw@axislines
}%
\def\pgfplots@ternary@draw@axislines{%
	\ifpgfplots@separate@axis@lines
		\scope[/pgfplots/every outer x axis line,
			xdiscont,decoration={pre length=\csname xdisstart\endcsname, post length=\csname xdisend\endcsname}]
		\draw decorate {
			\pgfextra
				\pgfpathmoveto{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplotsqpointxyz001}%
				\pgfpathlineto{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplotsqpointxyz100}%
			\endpgfextra 
		};
		\endscope
		%
		\scope[/pgfplots/every outer y axis line,
			ydiscont,decoration={pre length=\csname ydisstart\endcsname, post length=\csname ydisend\endcsname}]
		\draw decorate {
			\pgfextra
		\pgfpathmoveto{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplotsqpointxyz100}%
		\pgfpathlineto{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplotsqpointxyz010}%
			\endpgfextra 
		};
		\endscope
		%
		\scope[/pgfplots/every outer z axis line,
			zdiscont,decoration={pre length=\csname zdisstart\endcsname, post length=\csname zdisend\endcsname}]
		\draw decorate {
			\pgfextra
		\pgfpathmoveto{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplotsqpointxyz010}%
		\pgfpathlineto{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplotsqpointxyz001}%
			\endpgfextra 
		};
		\endscope
	\else
		\draw[
			/pgfplots/every outer x axis line, % FIXME! these outer styles need much more attention :-(
			/pgfplots/every outer y axis line]
		\pgfextra{%
		\pgfpathmoveto{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplotsqpointxyz001}%
		\pgfpathlineto{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplotsqpointxyz100}%
		\pgfpathlineto{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplotsqpointxyz010}%
		\pgfpathlineto{\global\pgfplots@ternary@next@is@unitintervaltrue\pgfplotsqpointxyz001}%
		};
	\fi
}%

\def\pgfplots@ternary@draw@axis@post{%
	% do nothing. There is no 3d box to draw here.
}%

\def\pgfplotspointouternormalvectorofaxis@ternary#1#2#3\relax{%
	\if v#1%
		\pgfpointadd
			{\pgfqpointscale{-1}{\pgfplotspointyaxis}}%
			{\pgfplotspointzaxis}%
	\else
		\if v#2%
			\pgfpointadd
				{\pgfplotspointxaxis}%
				{\pgfqpointscale{-1}{\pgfplotspointzaxis}}%
		\else
			\pgfpointadd
				{\pgfqpointscale{-1}{\pgfplotspointxaxis}}%
				{\pgfplotspointyaxis}%
		\fi
	\fi
	\pgf@process{\pgfpointnormalised{}}%
	\endgroup
}%

\endinput
