%--------------------------------------------
%
% Package pgfplots, library for ternary plots (triangular axes).
%
% Copyright 2010 by Christian Feuers√§nger.
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%
%--------------------------------------------

\pgfplotsdefineaxistype{triangle}{%
	\pgfplots@ternary@activate
}%
\pgfplotsdefineaxistype{ternary}{%
	\pgfplots@ternary@activate
}%

\def\pgfplots@ternary@activate{%
	\let\pgfplotsqpointxyz=\pgfplots@ternary@qpointxyz
	\let\pgfplots@draw@axis=\pgfplots@ternary@draw@axis
	\let\pgfplots@draw@axis@post=\pgfplots@ternary@draw@axis@post
	\let\pgfplots@initsizes=\pgfplots@ternary@initsizes
	\let\pgfplots@initsizes@setunitvector=\pgfplots@ternary@initsizes@setunitvector
	\pgfkeyssetvalue{/pgfplots/view/az}{}%
	\pgfkeyssetvalue{/pgfplots/view/el}{}%
	\def\pgfplots@xticklabel@pos{}%
	\def\pgfplots@yticklabel@pos{}%
	\def\pgfplots@zticklabel@pos{}%
	\def\pgfplots@xaxislinesnum{1}%
	\def\pgfplots@yaxislinesnum{3}%
	\def\pgfplots@zaxislinesnum{3}%
	\def\pgfplotsifaxissurfaceisforeground##1##2##3{##2}%
	%--------------------------------------------------
	% 	\pgfplots@error{Sorry, 'axis type=triangle' needs a three dimensional axes. Make sure you supplied three dimensional coordinates (using \string\addplot3, for example)}%
	%-------------------------------------------------- 
}%


\let\pgfplots@ternary@initsizes@orig=\pgfplots@initsizes
\def\pgfplots@ternary@initsizes{%
	\pgfplots@ternary@init@pre@map x
	\pgfplots@ternary@init@pre@map y
	\pgfplots@ternary@init@pre@map z
	\pgfplots@ternary@initsizes@orig
}%

\def\pgfplots@ternary@init@pre@map#1{%
	\pgfmath@basic@subtract@
		{\csname pgfplots@#1max\endcsname}
		{\csname pgfplots@#1min\endcsname}%
	\pgfmath@basic@reciprocal@\pgfmathresult
	\expandafter\let\csname pgfplots@ternary@pre@map@scale@#1\endcsname=\pgfmathresult
}

\def\pgfplots@ternary@initsizes@setunitvector#1#2#3#4{%
	\def#4{0}% whether we have (#1,0) or (0,#1)
	\ifcase#2%
		\pgfsetxvec{\pgfplots@ternary@qpointxyz\pgfplots@xmax00}%
	\or
		\pgfsetyvec{\pgfplots@ternary@qpointxyz0\pgfplots@ymax0}%
	\or
		\pgfsetzvec{\pgfplots@ternary@qpointxyz00\pgfplots@zmax}%
	\fi
	\pgfmathveclen{\csname pgf@#1x\endcsname}{\csname pgf@#1y\endcsname}%
	% The numbers 1/||e_x|| and 1/||e_y|| are used by the tick
	% placement code to convert between logical and physical
	% coordinates.
	\expandafter\let\csname pgfplots@#1@veclength\endcsname=\pgfmathresult
	\pgfplotsmath@ifzero{\pgfmathresult}{%
		\expandafter\def\csname pgfplots@#1@inverseveclength\endcsname{infty}%
	}{%
		\expandafter\pgfmathreciprocal@\expandafter{\pgfmathresult}%
		\expandafter\let\csname pgfplots@#1@inverseveclength\endcsname=\pgfmathresult
	}%
}%

% gx(x,y,z) = 0.5 * (x + 2*z)/(x+y+z)
% gy(x,y,z) = (sqrt(3) / 2) * x / (x+y+z)
\def\pgfplots@ternary@qpointxyz#1#2#3{%
	\pgf@process{%
		\dimen1=#1pt
		\advance\dimen1 by-\pgfplots@xmin pt
		\dimen1=\pgfplots@ternary@pre@map@scale@x\dimen1
		%
		\dimen2=#2pt
		\advance\dimen2 by-\pgfplots@ymin pt
		\dimen2=\pgfplots@ternary@pre@map@scale@y\dimen2
		%
		\dimen3=#3pt
		\advance\dimen3 by-\pgfplots@zmin pt
		\dimen3=\pgfplots@ternary@pre@map@scale@z\dimen3
		%
		\edef\pgfplots@temp{{\the\dimen1}{\the\dimen2}{\the\dimen3}}%
		\expandafter\pgfplots@ternary@qpointxyz@\pgfplots@temp
	}%
}%
\def\pgfplots@ternary@qpointxyz@#1#2#3{%
	\dimen0=#1
	\advance\dimen0 by#2
	\advance\dimen0 by#3
	\edef\pgfplots@ternary@sum{\pgf@sys@tonumber{\dimen0}}%
	\pgfmath@basic@divide@
		{200}% for testing and debugging.
		{\pgfplots@ternary@sum}%
	\let\pgfplots@ternary@scale=\pgfmathresult
	%
	\dimen1=#1
	\dimen3=#3
	\dimen3=2\dimen3
	\advance\dimen1 by \dimen3
	\dimen1=0.5\dimen1
	\pgf@x=\pgfplots@ternary@scale\dimen1
	%
	\dimen1=#1
	\dimen1=0.866025403784\dimen1 % *= sqrt(3)/2 
	\pgf@y=\pgfplots@ternary@scale\dimen1
	%
}%

\def\pgfplots@ternary@draw@axis{%
	%
	% this should become the line for varying y:
	\pgfplotspointonorientedsurfaceabsetupforsetz{\pgfplots@zmin}{0}%
	% it REQUIRES 
	% 	z fixed to \pgfplots@zmin (ok)
	% 	x fixed to \pgfplots@xmax (to be done by options)
	\pgfplots@draw@axis@insurface yxz
	%
	% this should become the line for varying x:
	\pgfplotspointonorientedsurfaceabsetupforsetz{\pgfplots@zmax}{1}%
	% it REQUIRES 
	% 	z fixed to \pgfplots@zmax (ok)
	% 	y fixed to \pgfplots@ymin (to be done by options)
	\pgfplots@draw@axis@insurface xyz
	%
	% this should become the line for varying z:
	\pgfplotspointonorientedsurfaceabsetupforsetx{\pgfplots@xmin}{0}%
	% it REQUIRES 
	% 	x fixed to \pgfplots@xmin (ok)
	% 	y fixed to \pgfplots@ymax (to be done by options)
	\pgfplots@draw@axis@insurface zyx
}%

\def\pgfplots@ternary@draw@axis@post{%
	% do nothing. There is no 3d box to draw here.
}%
\endinput
