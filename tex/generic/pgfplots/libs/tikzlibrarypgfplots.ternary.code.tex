%--------------------------------------------
%
% Package pgfplots, library for ternary plots (triangular axes).
%
% Copyright 2010 by Christian Feuers√§nger.
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%
% 
% This is a library to draw ternary diagrams.
%
% How to read a ternary diagram:
%  http://www.sv.vt.edu/classes/MSE2094_NoteBook/96ClassProj/experimental/ternary2.html
% A ternary diagram visualizes percentages of three components in a
% triangle.
%
% Sometimes there is also contour data drawn on top of the ternary
% diagram, i.e. data (x,y,z, T(x,y,z) ), but I can't do that yet.
%
%http://staff.aist.go.jp/a.noda/programs/ternary/ternary-en.html
%
%
% FIXME : it won't work this way.
%
% I misunderstood the nonlinear transformation and its implications.
%
% how do you draw the x axis!? It is
%   (1,0,0) -- (0,0,1)
% and *NOT*
% 	(1,0,0) -- (1,0,1) !
% The oriented surf framework always keeps one coordinate fixed;
% that's not useful here.
%
% Furthermore, the condition x+y+z = 1  is never met by any of the
% tick line or grid line paths. It won't work.
%
% Can I change the meaning of "oriented surf"? Otherwise, I'd need to
% re-implement everything. Not very extensible
%--------------------------------------------

\pgfplotsdefineaxistype{triangle}{%
	\pgfplots@ternary@activate
}%
\pgfplotsdefineaxistype{ternary}{%
	\pgfplots@ternary@activate
}%

\def\pgfplots@ternary@activate{%
	\let\pgfplotsqpointxyz=\pgfplots@ternary@qpointxyz
	\let\pgfplots@draw@axis=\pgfplots@ternary@draw@axis
	\let\pgfplots@draw@axis@post=\pgfplots@ternary@draw@axis@post
	\let\pgfplots@initsizes=\pgfplots@ternary@initsizes
	\let\pgfplotspoint@initialisation@axes=\pgfplots@ternary@point@initialisation@axes
	\let\pgfplotspoint@initialisation@units=\pgfplots@ternary@point@initialisation@units
	\let\pgfplots@initsizes@setunitvector=\pgfplots@ternary@initsizes@setunitvector
	\let\pgfplotspointouternormalvectorofaxis@=\pgfplotspointouternormalvectorofaxis@ternary
	\pgfkeys{/pgfplots/oriented surf installed/.add={}{%
		\let\pgfplotspointonorientedsurfaceab@ternary@orig=\pgfplotspointonorientedsurfaceab
		\let\pgfplotspointonorientedsurfaceab=\pgfplotspointonorientedsurfaceab@ternary
	}}%
	\pgfkeyssetvalue{/pgfplots/view/az}{}%
	\pgfkeyssetvalue{/pgfplots/view/el}{}%
	\let\pgfplots@set@options@sanitize=\relax
	\let\pgfplots@set@options@sanitizemode=\relax
	\pgfplotsset{
		enlargelimits=false,
		clip=false,
		disabledatascaling,
		xmin=0,xmax=1,
		ymin=0,ymax=1,
		zmin=0,zmax=1,
	}%
	\def\pgfplots@xticklabel@pos{}%
	\def\pgfplots@yticklabel@pos{}%
	\def\pgfplots@zticklabel@pos{}%
	%\def\pgfplots@xaxislinesnum{1}%
	%\def\pgfplots@yaxislinesnum{3}%
	%\def\pgfplots@zaxislinesnum{3}%
	\def\pgfplotsifaxissurfaceisforeground##1##2##3{##2}%
	\def\pgfplots@init@ticklabelaxisspecfor##1##2{}%
	\def\pgfplots@xticklabelaxisspec{v01}%
	\def\pgfplots@yticklabelaxisspec{1v0}%
	\def\pgfplots@zticklabelaxisspec{01v}%
	\def\pgfplots@ifaxisline@B@onorientedsurf@should@be@drawn@##1##2##3{%
		\pgfplotspointonorientedsurfaceabtolinespec v##1%
		\edef\pgfplots@loc@TMPe{\csname pgfplots@\pgfplotspointonorientedsurfaceA ticklabelaxisspec\endcsname}%
		\ifx\pgfplots@loc@TMPe\pgfplotsretval
			##2%
		\else
			##3%
		\fi
	}%
	\let\pgfplots@ifaxisline@B@onorientedsurf@should@be@drawn=\pgfplots@ifaxisline@B@onorientedsurf@should@be@drawn@%
}%

\def\pgfplotspointonorientedsurfaceab@ternary#1#2{%
	\pgfmath@basic@subtract@{#2}{\csname pgfplots@\pgfplotspointonorientedsurfaceB min\endcsname}%
	\pgfmath@basic@multiply@{\pgfmathresult}{\csname pgfplots@ternary@pre@map@scale@\pgfplotspointonorientedsurfaceB\endcsname}%
	\let\pgfplotspointonorientedsurfaceab@ternary@B=\pgfmathresult
	\ifcase\pgfplotspointonorientedsurfacespecsymbol
	\or
	\else	
		\pgfplots@error{Internal processing error: only \string\pgfplotspointonorientedsurfaceab\space for ternary axes works only for oriented surfs fixed to LOWER or UPPER axis limits.}%
	\fi
	\pgfmath@basic@subtract@{1}{\pgfplotspointonorientedsurfacespecsymbol}%
	\pgfmath@basic@subtract@{\pgfmathresult}{\pgfplotspointonorientedsurfaceab@ternary@B}%
	\let\pgfplotspointonorientedsurfaceab@ternary@A=\pgfmathresult
	%
	\pgfplotspointonorientedsurfaceab@ternary@orig{\pgfplotspointonorientedsurfaceab@ternary@A}{\pgfplotspointonorientedsurfaceab@ternary@B}%
}%

\let\pgfplots@ternary@initsizes@orig=\pgfplots@initsizes
\def\pgfplots@ternary@initsizes{%
	\ifpgfplots@threedim
	\else
	 	\pgfplots@error{Sorry, 'axis type=triangle' needs a three dimensional axes. Make sure you supplied three dimensional coordinates (using \string\addplot3, for example). This error is critical; I can't recover}%
	\fi
	\pgfplots@ternary@init@pre@map x
	\pgfplots@ternary@init@pre@map y
	\pgfplots@ternary@init@pre@map z
	\pgfplots@ternary@initsizes@orig
}%

\def\pgfplots@ternary@init@pre@map#1{%
	\pgfmath@basic@subtract@
		{\csname pgfplots@#1max\endcsname}
		{\csname pgfplots@#1min\endcsname}%
	\pgfmath@basic@reciprocal@\pgfmathresult
	\expandafter\let\csname pgfplots@ternary@pre@map@scale@#1\endcsname=\pgfmathresult
}

\def\pgfplots@ternary@initsizes@setunitvector#1#2#3#4{%
	\def#4{0}% whether we have (#1,0) or (0,#1)
	\ifcase#2%
		\pgfsetxvec{%
			\pgfpointdiff
				{\pgfplots@ternary@qpointxyz001}
				{\pgfplots@ternary@qpointxyz100}%
		}%
	\or
		\pgfsetyvec{%
			\pgfpointdiff
				{\pgfplots@ternary@qpointxyz100}
				{\pgfplots@ternary@qpointxyz010}%
		}%
	\or
		\pgfsetzvec{%
			\pgfpointdiff
				{\pgfplots@ternary@qpointxyz010}
				{\pgfplots@ternary@qpointxyz001}%
		}%
	\fi
	\pgfmathveclen{\csname pgf@#1x\endcsname}{\csname pgf@#1y\endcsname}%
	% The numbers 1/||e_x|| and 1/||e_y|| are used by the tick
	% placement code to convert between logical and physical
	% coordinates.
	\expandafter\let\csname pgfplots@#1@veclength\endcsname=\pgfmathresult
	\pgfplotsmath@ifzero{\pgfmathresult}{%
		\expandafter\def\csname pgfplots@#1@inverseveclength\endcsname{infty}%
	}{%
		\expandafter\pgfmathreciprocal@\expandafter{\pgfmathresult}%
		\expandafter\let\csname pgfplots@#1@inverseveclength\endcsname=\pgfmathresult
	}%
%\message{-> got unitvector(#1) = (\the\csname pgf@#1x\endcsname, \the\csname pgf@#1y\endcsname).}%
}%

% gx(x,y,z) = 0.5 * (x + 2*z)/(x+y+z)
% gy(x,y,z) = (sqrt(3) / 2) * x / (x+y+z)
\def\pgfplots@ternary@qpointxyz#1#2#3{%
	\pgf@process{%
		\dimen1=#1pt
		\advance\dimen1 by-\pgfplots@xmin pt
		\dimen1=\pgfplots@ternary@pre@map@scale@x\dimen1
		%
		\dimen2=#2pt
		\advance\dimen2 by-\pgfplots@ymin pt
		\dimen2=\pgfplots@ternary@pre@map@scale@y\dimen2
		%
		\dimen3=#3pt
		\advance\dimen3 by-\pgfplots@zmin pt
		\dimen3=\pgfplots@ternary@pre@map@scale@z\dimen3
		%
		\edef\pgfplots@temp{{\the\dimen1}{\the\dimen2}{\the\dimen3}}%
		\expandafter\pgfplots@ternary@qpointxyz@\pgfplots@temp
	}%
}%
\def\pgfplots@ternary@qpointxyz@#1#2#3{%
	\dimen0=#1
	\advance\dimen0 by#2
	\advance\dimen0 by#3
	\edef\pgfplots@ternary@sum{\pgf@sys@tonumber{\dimen0}}%
	\pgfmath@basic@divide@
		{200}% for testing and debugging.
		{\pgfplots@ternary@sum}%
	\let\pgfplots@ternary@scale=\pgfmathresult
	%
	\dimen1=#1
	\dimen3=#3
	\dimen3=2\dimen3
	\advance\dimen1 by \dimen3
	\dimen1=0.5\dimen1
	\pgf@x=\pgfplots@ternary@scale\dimen1
	%
	\dimen1=#1
	\dimen1=0.866025403784\dimen1 % *= sqrt(3)/2 
	\pgf@y=\pgfplots@ternary@scale\dimen1
	%
}%

% POSTCONDITION: the macros
% 	\pgfplotspointminminmin
% 	\pgfplotspoint[xyz]axis
% 	\pgfplotspoint[xyz]axislength
%   are defined (globally).
\def\pgfplots@ternary@point@initialisation@axes{%
	\begingroup
	\xdef\pgfplotspointminminmin{\noexpand\pgfpointorigin}%
	%
	\pgfplotsqpointxyz\pgfplots@xmax\pgfplots@ymin\pgfplots@zmin
	\pgfmathveclen{\pgf@x}{\pgf@y}%
	\xdef\pgfplotspointxaxislength{\pgfmathresult pt}%
	\pgfplotsqpointxyz\pgfplots@xmax\pgfplots@ymin\pgfplots@zmax
	\xdef\pgfplotspointxaxis{\noexpand\pgf@x=\the\pgf@x\space\noexpand\pgf@y=\the\pgf@y\space}%
	%
	\pgfplotsqpointxyz\pgfplots@xmin\pgfplots@ymax\pgfplots@zmin
	\pgfmathveclen{\pgf@x}{\pgf@y}%
	\xdef\pgfplotspointyaxislength{\pgfmathresult pt}%
	\pgfplotsqpointxyz\pgfplots@xmax\pgfplots@ymax\pgfplots@zmin
	\xdef\pgfplotspointyaxis{\noexpand\pgf@x=\the\pgf@x\space\noexpand\pgf@y=\the\pgf@y\space}%
	%
	\pgfplotsqpointxyz\pgfplots@xmin\pgfplots@ymin\pgfplots@zmax
	\pgfmathveclen{\pgf@x}{\pgf@y}%
	\xdef\pgfplotspointzaxislength{\pgfmathresult pt}%
	\pgfplotsqpointxyz\pgfplots@xmin\pgfplots@ymax\pgfplots@zmax
	\xdef\pgfplotspointzaxis{\noexpand\pgf@x=\the\pgf@x\space\noexpand\pgf@y=\the\pgf@y\space}%
	\endgroup
	%
}


% PRECONDITION:
% 	the unit vectors are set up
%
% POSTCONDITION:
% 	\pgfplotspointunit[xyz]
% 	\pgfplotspointunit[xyz]length
% 	\pgfplotspointunit[xyz]invlength
% 	are all set up.
\def\pgfplots@ternary@point@initialisation@units{%
	\edef\pgfplotspointunitx{\pgf@x=\the\pgf@xx\space\pgf@y=\the\pgf@xy\space}%
	\edef\pgfplotspointunity{\pgf@x=\the\pgf@yx\space\pgf@y=\the\pgf@yy\space}%
	\let\pgfplotsunitxlength=\pgfplots@x@veclength
	\let\pgfplotsunitylength=\pgfplots@y@veclength
	\let\pgfplotsunitxinvlength=\pgfplots@x@inverseveclength
	\let\pgfplotsunityinvlength=\pgfplots@y@inverseveclength
	\ifpgfplots@threedim
		\edef\pgfplotspointunitz{\pgf@x=\the\pgf@zx\space\pgf@y=\the\pgf@zy\space}%
		\let\pgfplotsunitzlength=\pgfplots@z@veclength
		\let\pgfplotsunitzinvlength=\pgfplots@z@inverseveclength
	\fi
}%
\def\pgfplots@ternary@draw@axis{%
	\pgfplots@ternary@draw@axislines
}%
\def\pgfplots@ternary@draw@axislines{%
	\ifpgfplots@separate@axis@lines
		\scope[/pgfplots/every outer x axis line,
			xdiscont,decoration={pre length=\csname xdisstart\endcsname, post length=\csname xdisend\endcsname}]
		\draw decorate {
			\pgfextra
				\pgfpathmoveto{\pgfplotsqpointxyz001}%
				\pgfpathlineto{\pgfplotsqpointxyz100}%
			\endpgfextra 
		};
		\endscope
		%
		\scope[/pgfplots/every outer y axis line,
			ydiscont,decoration={pre length=\csname ydisstart\endcsname, post length=\csname ydisend\endcsname}]
		\draw decorate {
			\pgfextra
		\pgfpathmoveto{\pgfplotsqpointxyz100}%
		\pgfpathlineto{\pgfplotsqpointxyz010}%
			\endpgfextra 
		};
		\endscope
		%
		\scope[/pgfplots/every outer z axis line,
			zdiscont,decoration={pre length=\csname zdisstart\endcsname, post length=\csname zdisend\endcsname}]
		\draw decorate {
			\pgfextra
		\pgfpathmoveto{\pgfplotsqpointxyz010}%
		\pgfpathlineto{\pgfplotsqpointxyz001}%
			\endpgfextra 
		};
		\endscope
	\else
		\draw[
			/pgfplots/every outer x axis line, % FIXME! these outer styles need much more attention :-(
			/pgfplots/every outer y axis line]
		\pgfextra{%
		\pgfpathmoveto{\pgfplotsqpointxyz001}%
		\pgfpathlineto{\pgfplotsqpointxyz100}%
		\pgfpathlineto{\pgfplotsqpointxyz010}%
		\pgfpathlineto{\pgfplotsqpointxyz001}%
		};
	\fi
}%

\def\pgfplots@ternary@draw@axis@post{%
	% do nothing. There is no 3d box to draw here.
}%

\def\pgfplotspointouternormalvectorofaxis@ternary#1#2#3\relax{%
	\if v#1%
		\pgfpointadd
			{\pgfplotspointyaxis}%
			{\pgfplotspointzaxis}%
	\else
		\if v#2%
			\pgfpointadd
				{\pgfplotspointxaxis}%
				{\pgfplotspointzaxis}%
		\else
			\pgfpointadd
				{\pgfplotspointxaxis}%
				{\pgfplotspointyaxis}%
		\fi
	\fi
	\pgf@process{\pgfpointnormalised{}}%
}%
\endinput
