%--------------------------------------------
%
% Package pgfplots
%
% Provides a user-friendly interface to create function plots (normal
% plots, semi-logplots and double-logplots).
% 
% It is based on Till Tantau's PGF package.
%
% Copyright 2013 by Christian Feuersaenger
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%
%--------------------------------------------


% This library adds support for high-level instructions for "fill area
% between two arbitrary plots of functions".
%
% It activates the syntax \pgfpathfillbetween
% where A and B are two plots named by 'name path='.
%
% In fact, this here is not much more than a low-level invocation of
% \pgfpathfillbetween
% and a couple of styles. It could become a TikZ library because it
% actually works on any two named paths, but it has its restrictions
% regarding the supported input paths: both need to be plots of
% functions (non-intersecting, should have at most one function value
% for each canvas X coord)

\pgfutil@IfUndefined{pgfplotsset}{%
	\pgferror{Please load pgfplots before pgfplots.fillbetween.}%
	\endinput
}{}%

\usetikzlibrary{intersections}
\usetikzlibrary{decorations.softclip}

\pgfutil@IfUndefined{pgfintersectiongetsolutiontimes}{%
	\pgfplotsusecompatibilityfile{pgflibraryintersections.code.tex}%
}{}%

\pgfkeys{%
	/tikz/fill between/of/.code=\tikzlibraryfillbetween@parse#1\pgf@stop,
	%
	/tikz/fill between/on layer/.initial=pre main,
	/tikz/fill between/every segment/.style={},
	/tikz/fill between/every odd segment/.style={},
	/tikz/fill between/every even segment/.style={},
	%
	% soft clip={(axis cs:0,0) rectangle (axis cs:1,1)}
	/tikz/fill between/soft clip/.style={
		/tikz/fill between/soft clip first={#1},%
		/tikz/fill between/soft clip second={#1},%
	},%
	/tikz/fill between/soft clip first/.initial=,%
	/tikz/fill between/soft clip second/.initial=,
	%
	% #1: drawing options.
	/tikz/fill between/@draw style/.style={
		/pgf/fill between/result stream/begin/.code={%
			\gdef\tikzsegmentindex{0}%
		},%
		/pgf/fill between/result stream/next ready/.code={%
			\let\pgflibraryfill@path=\pgfretval
			\def\pgfplots@loc@TMPa{%
				/tikz/fill between/every segment,
				#1,%
				/tikz/fill between/every segment no \tikzsegmentindex/.try,
			}%
			\ifodd\tikzsegmentindex\relax
				\expandafter\def\expandafter\pgfplots@loc@TMPa\expandafter{\pgfplots@loc@TMPa
					/tikz/fill between/every odd segment,
				}%
			\else
				\expandafter\def\expandafter\pgfplots@loc@TMPa\expandafter{\pgfplots@loc@TMPa
					/tikz/fill between/every even segment,
				}%
			\fi
			%
			\expandafter\fill\expandafter[\pgfplots@loc@TMPa]
				\pgfextra \pgfsetpathandBB{\pgflibraryfill@path}\endpgfextra;%
			\pgfplotsutil@advancestringcounter@global\tikzsegmentindex
		},%
		/pgf/fill between/result stream/end/.code=,%
	},
	/tikz/fill between/.search also={/pgf/fill between,/pgfplots},
	%
	%
	%
	%--------------------------------------------------
	% /pgfplots/execute at begin axis@@/.add={%
	% 	\def\b@pgfplotslibraryfill@added
	% }{%
	% 	
	% },%
	%-------------------------------------------------- 
}

\def\tikzlibraryfillbetween@parse#1 and #2\pgf@stop{%
	\def\tikz@fillbetween@a{#1}%
	\def\tikz@fillbetween@b{#2}%
}%

% \tikzfillbetween[<options>]{<draw style>}
%
% <options> must contain 'of=<A> and <B>' and may configure how the
% area is computed.
%
% <draw style> affects every drawn region.
%
\def\tikzfillbetween{\pgfutil@ifnextchar[{\tikzfillbetween@opt}{\tikzfillbetween@opt[]}}
\def\tikzfillbetween@opt[#1]#2{%
	\begingroup
	\pgfqkeys{/tikz/fill between}{% 
		% prepare the low-level path generation instruction(s):
		/tikz/fill between/@draw style={#2},%
		%
		% set up input options:
		#1,%
	}%
	% automagically try to use the correct layer:
	\pgfkeysgetvalue{/tikz/fill between/on layer}\tikzlibraryfillbetween@path@layer@name
	\tikzlibraryfillbetween@determine@layer
	%
	\ifx\tikzlibraryfillbetween@path@layer@name\pgfutil@empty \else
		\pgfonlayer{\tikzlibraryfillbetween@path@layer@name}%
	\fi
	%
		\tikzlibraryfillbetween@path@generatepath
	%
	\ifx\tikzlibraryfillbetween@path@layer@name\pgfutil@empty \else
		\endpgfonlayer%
	\fi
	%
	\endgroup
}%

% Defines \tikzlibraryfillbetween@path@layer@name
\def\tikzlibraryfillbetween@determine@layer{%
	\ifx\tikzlibraryfillbetween@path@layer@name\pgfutil@empty
	\else
		\pgfutil@IfUndefined{pgf@layerlist}{%
			% hm. No layers active!? A pity...
			\tikzlibraryfillbetween@path@warn@layer
			\let\tikzlibraryfillbetween@path@layer@name\pgfutil@empty%
		}{%
			\edef\pgfplots@loc@TMPa{\noexpand\pgfutil@in@{\tikzlibraryfillbetween@path@layer@name}}%
			\expandafter\pgfplots@loc@TMPa\expandafter{\pgf@layerlist}%
			\ifpgfutil@in@
			\else
				\tikzlibraryfillbetween@path@warn@layer
				\let\tikzlibraryfillbetween@path@layer@name\pgfutil@empty%
			\fi
		}%
	\fi
}%

\def\tikzlibraryfillbetween@path@warn@layer{%
	\pgfplots@warning{'fill between': Could not activate graphics layer '\tikzlibraryfillbetween@path@layer@name'. Filled path will be on top of the other ones. Please ensure that '\tikzlibraryfillbetween@path@layer@name' is somewhere in the layer list (or set '/tikz/fill between/on layer=').}%
}%

\def\tikzlibraryfillbetween@parse@softclip{%
	\pgfkeysgetvalue{/tikz/fill between/soft clip first}\pgf@temp
	\pgfkeysgetvalue{/tikz/fill between/soft clip second}\pgf@tempb
	\ifx\pgf@temp\pgf@tempb
		% Ah - both have the same value!
		\ifx\pgf@temp\pgfutil@empty
			% ... and both are empty.
			\pgffillbetweensetsoftclippath{\pgfutil@empty}%
		\else
			% ... and both contain some path! Process it (once):
			\def\tikz@marshal{\tikzlibsoftclip@setkey{\pgffillbetweensetsoftclippath}}%
			\expandafter\tikz@marshal\pgf@temp\pgf@stop
		\fi
	\else
		% handle 'soft clip first':
		\ifx\pgf@temp\pgfutil@empty
			\pgffillbetweensetsoftclippathfirst{\pgfutil@empty}%
		\else
			\def\tikz@marshal{\tikzlibsoftclip@setkey{\pgffillbetweensetsoftclippathfirst}}%
			\expandafter\tikz@marshal\pgf@temp\pgf@stop
		\fi
		%
		% handle 'soft clip second':
		\pgfkeysgetvalue{/tikz/fill between/soft clip second}\pgf@tempb
		\ifx\pgf@tempb\pgfutil@empty
			\pgffillbetweensetsoftclippathsecond{\pgfutil@empty}%
		\else
			\def\tikz@marshal{\tikzlibsoftclip@setkey{\pgffillbetweensetsoftclippathsecond}}%
			\expandafter\tikz@marshal\pgf@tempb\pgf@stop
		\fi
	\fi
}%

\def\tikzlibraryfillbetween@path@generatepath{%
	%
	\tikzlibraryfillbetween@parse@softclip
	%
	\tikzlibraryfillbetween@path@check
	\expandafter\let\expandafter\tikz@fillbetween@a@path
		\csname tikz@intersect@path@name@\tikz@fillbetween@a\endcsname
	\expandafter\let\expandafter\tikz@fillbetween@b@path
		\csname tikz@intersect@path@name@\tikz@fillbetween@b\endcsname
	%
	\pgfpathfillbetween{\tikz@fillbetween@a@path}{\tikz@fillbetween@b@path}%
}%

\def\tikzlibraryfillbetween@path@check{%
	\pgfutil@IfUndefined{tikz@intersect@path@name@\tikz@fillbetween@a}{%
		\pgferror
		{fill between: the mandatory argument 'of=<name path A> and <name path B> is missing or has empty arguments. Please ensure that the option has been set and that both path names have been assigned (perhaps you need 'name path global=\tikz@fillbetween@a' somewhere?)}%
	}{}%
	\pgfutil@IfUndefined{tikz@intersect@path@name@\tikz@fillbetween@b}{%
		\pgferror
		{fill between: the mandatory argument 'of=<name path A> and <name path B> is missing or has empty arguments. Please ensure that the option has been set and that both path names have been assigned (perhaps you need 'name path global=\tikz@fillbetween@b' somewhere?)}%
	}{}%
}


%-----------------------------------------
%
% Utilities to work with path segments
%
%-----------------------------------------

% Defines \pgfplotsretval such that it contains the named path '#1'
\def\tikzgetnamedpath#1{%
	\pgfutil@IfUndefined{tikz@intersect@path@name@#1}{%
		\pgferror{There is no named path called '#1'. Perhaps you misspelled it?}%
	}{%
		\expandafter\let\expandafter\pgfretval
			\csname tikz@intersect@path@name@#1\endcsname
	}%
}%

% Executes #2 if #1 is a named path and #3 otherwise.
\def\tikzifisnamedpath#1#2#3{%
	\pgfutil@IfUndefined{tikz@intersect@path@name@#1}{%
		\def\tikz@next{#3}%
	}{%
		\def\tikz@next{#2}%
	}%
	\tikz@next
}%

\endinput
